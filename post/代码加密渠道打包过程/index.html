<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>代码加密,渠道打包过程 - farwmarth</title>
    <meta name="keywords" content="程序员">
    
    <meta property="og:title" content="代码加密,渠道打包过程">
    <meta property="og:site_name" content="farwmarth">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="代码加密,渠道打包过程 - farwmarth" />
    <meta name="description" content="game"> 
    <link rel="shortcut icon" href="https://farwmarth.com/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://farwmarth.com/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://farwmarth.com/img/apple-touch-icon.png" />
    <link href="https://farwmarth.com/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/css/main.css" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://farwmarth.com/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">farwmarth</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Those that can,do.Those that can&#39;t ,complain</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/douban/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-heart"></i> <br />豆瓣
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/music/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-music"></i> <br />音乐
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://farwmarth.com/post/%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%AF%86%E6%B8%A0%E9%81%93%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" itemprop="url">
        代码加密,渠道打包过程
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2014-10-10">
    2014-10-10
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://farwmarth.com/categories/cocos2d-x" itemprop="url" rel="index">
        <span itemprop="name">cocos2d-x</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">5952 字 ~12分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>前段时间就计划着把项目里用到的一些通用的东西整理出来，正好最近项目不是太忙，就整理一下。</p>
<h2 id="lua代码加密"><strong>lua代码加密</strong></h2>
<p>  我们的项目是基于cocos2dx 2.2.2 用lua开发,支持luajit,所以lua代码加密就把quick-cocos2dx的代码加密直接迁移过来(实际上就是用luajit把lua源码编译成预字节码)</p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2014-10-10-%E4%B8%8B%E5%8D%882.37.426.png" alt=""></p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2014-10-10-%E4%B8%8B%E5%8D%882.38.37-34.png" alt="">
调用compile_script.sh 参数说明:</p>
<p>-i 在加密的lua源码目录
-o 加密后的压缩包
-x 排除的lua文件用逗号隔开.</p>
<p>c++端的解析流程和quick大同小异:解析zip压缩包,用pakcage.preload通过lua_loadbuffer来不原。唯一有点不一样的地方是.多级目录时luajit会以点号分隔,但是我们的项目做了一段时间才做加密，所以在不不改变require的引用 语法前提下，稍微修改了一下还原步骤,将’.’还原成’/&rsquo;</p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2014-10-10-%E4%B8%8B%E5%8D%885.30.164.png" alt=""></p>
<h2 id="渠道打包"><strong>渠道打包</strong></h2>
<p>需要跨平台我选择了python作为脚本。打包流程基本流程为:</p>
<ul>
<li>加密lua代码</li>
<li>android平台编译so,或者从svn获取最新的so</li>
<li>Android平台拷贝资源到assets,iOS平台拷贝到编译目录</li>
<li>android平台上调用ant更改版本号编译项目,ios上用PlistBuddy更改版本号,用xctool命令行编译项目</li>
</ul>
<p>项目目录结构</p>
<!-- raw HTML omitted -->
<p>每个渠道一个目录,Classes目录为公共c++代码,各平台共用.proj.android.base目录为android的基础类库依赖libcocos2dx的java工程,基础类库给各android渠道项目共用,proj.ios.common为oc公共代码给iOS各渠道项目共用。</p>
<p><strong>android平台的编译和打包解析</strong></p>
<p>**     基础类库mk配置**</p>
<p>为了共用代码将so编译放在基础类库proj.android.base中.mk配置如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">LOCAL_PATH :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>call my-dir<span style="color:#66d9ef">)</span>
include<span style="color:#66d9ef">$(</span>CLEAR_VARS<span style="color:#66d9ef">)</span>
LOCAL_MODULE :<span style="color:#f92672">=</span> cocos2dlua_shared
LOCAL_MODULE_FILENAME :<span style="color:#f92672">=</span> libcocos2dlua
<span style="color:#75715e"># 配置自己的源文件目录和源文件后缀名</span>
MY_FILES_PATH  :<span style="color:#f92672">=</span>  <span style="color:#66d9ef">$(</span>LOCAL_PATH<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\</span>
                   <span style="color:#66d9ef">$(</span>LOCAL_PATH<span style="color:#66d9ef">)</span>/../../Classes  <span style="color:#ae81ff">\</span>
MY_FILES_SUFFIX :<span style="color:#f92672">=</span> %.cpp %.c
<span style="color:#75715e"># 递归遍历目录下的所有的文件</span>
rwildcard<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>wildcard $1$2<span style="color:#66d9ef">)$(</span>foreach d,<span style="color:#66d9ef">$(</span>wildcard $1*<span style="color:#66d9ef">)</span>,<span style="color:#66d9ef">$(</span>call rwildcard,$d/,$2<span style="color:#66d9ef">))</span>
<span style="color:#75715e"># 获取相应的源文件</span>
MY_ALL_FILES :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>foreach src_path,<span style="color:#66d9ef">$(</span>MY_FILES_PATH<span style="color:#66d9ef">)</span>, <span style="color:#66d9ef">$(</span>call rwildcard,<span style="color:#66d9ef">$(</span>src_path<span style="color:#66d9ef">)</span>,*.*<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">)</span> 
MY_ALL_FILES :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>MY_ALL_FILES:<span style="color:#66d9ef">$(</span>MY_CPP_PATH<span style="color:#66d9ef">)</span>/./%<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>MY_CPP_PATH<span style="color:#66d9ef">)</span>%<span style="color:#66d9ef">)</span>
MY_SRC_LIST  :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>filter <span style="color:#66d9ef">$(</span>MY_FILES_SUFFIX<span style="color:#66d9ef">)</span>,<span style="color:#66d9ef">$(</span>MY_ALL_FILES<span style="color:#66d9ef">))</span> 
MY_SRC_LIST  :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>MY_SRC_LIST:<span style="color:#66d9ef">$(</span>LOCAL_PATH<span style="color:#66d9ef">)</span>/%<span style="color:#f92672">=</span>%<span style="color:#66d9ef">)</span>
<span style="color:#75715e"># 去除字串的重复单词</span>
define uniq <span style="color:#f92672">=</span>
  <span style="color:#66d9ef">$(</span>eval seen :<span style="color:#f92672">=</span><span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">$(</span>foreach _,$1,<span style="color:#66d9ef">$(if</span> <span style="color:#66d9ef">$(</span>filter $_,<span style="color:#e6db74">${</span>seen<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>,,<span style="color:#66d9ef">$(</span>eval seen <span style="color:#f92672">+=</span> $_<span style="color:#66d9ef">)))</span>
  <span style="color:#e6db74">${</span>seen<span style="color:#e6db74">}</span>
endef
<span style="color:#75715e"># 递归遍历获取所有目录</span>
MY_ALL_DIRS :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>dir <span style="color:#66d9ef">$(</span>foreach src_path,<span style="color:#66d9ef">$(</span>MY_FILES_PATH<span style="color:#66d9ef">)</span>, <span style="color:#66d9ef">$(</span>call rwildcard,<span style="color:#66d9ef">$(</span>src_path<span style="color:#66d9ef">)</span>,*/<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">)</span> <span style="color:#66d9ef">)</span>
MY_ALL_DIRS :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>call uniq,<span style="color:#66d9ef">$(</span>MY_ALL_DIRS<span style="color:#66d9ef">))</span>
<span style="color:#75715e"># 赋值给NDK编译系统</span>
LOCAL_SRC_FILES  :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>MY_SRC_LIST<span style="color:#66d9ef">)</span>
LOCAL_C_INCLUDES :<span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>MY_ALL_DIRS<span style="color:#66d9ef">)</span>
<span style="color:#75715e">#$(warning $(LOCAL_SRC_FILES))</span>
LOCAL_STATIC_LIBRARIES :<span style="color:#f92672">=</span> curl_static_prebuilt
LOCAL_WHOLE_STATIC_LIBRARIES :<span style="color:#f92672">=</span> cocos2dx_static
LOCAL_WHOLE_STATIC_LIBRARIES <span style="color:#f92672">+=</span> cocosdenshion_static
LOCAL_WHOLE_STATIC_LIBRARIES <span style="color:#f92672">+=</span> cocos_lua_static
LOCAL_WHOLE_STATIC_LIBRARIES <span style="color:#f92672">+=</span> box2d_static
LOCAL_WHOLE_STATIC_LIBRARIES <span style="color:#f92672">+=</span> chipmunk_static
LOCAL_WHOLE_STATIC_LIBRARIES <span style="color:#f92672">+=</span> cocos_extension_static
include<span style="color:#66d9ef">$(</span>BUILD_SHARED_LIBRARY<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,cocos2dx<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,CocosDenshion/android<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,scripting/lua/proj.android<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,cocos2dx/platform/third_party/android/prebuilt/libcurl<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,extensions<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,external/Box2D<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">$(</span>call import-module,external/chipmunk<span style="color:#66d9ef">)</span>
</code></pre></div><p>上面的配置会遍历项目jni目录和项目上级的classes目录达到自动添加cpp和.h的目的,这样不要频繁去理发mk文件了。</p>
<p>**    android项目的编译过程**</p>
<p>     <img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/15205029-814db23b81404db1bffc9ffb0da5f270.png" alt="15205029 814db23b81404db1bffc9ffb0da5f270" title="15205029-814db23b81404db1bffc9ffb0da5f270.png"></p>
<ul>
<li>首先.aidl(Android Interface Description Language)文件需要通过aidl工具转换成编译器能处理的Java接口文件</li>
<li>同时资源文件将被aapt (Asset Packaging Tool)处理为最终的resources.arsc，并生成R.java文件以使源码可以方便地访问到这些资源</li>
<li>Java的编译器将R.java, Java源码以及上述生成的接口文件统一编译成.class文件</li>
<li>不过.class并不是Android系统所能识别的格式，因而还要利用dex工具转化为Dalvik字节码。这其中还会加入所有需要的第三方库等文件</li>
<li>接下来系统将上面生成的dex，资源包，以及其它资源通过apkbuilder生成初始的apk文件包。这时还没有签名和优化</li>
<li>签名可以用Jarsigner，也可以用其它类似的工具。如果是在Debug模式下，所签名所用的keystore就是系统默认自带的，否则开发者需要提供自己的私钥以完成签名过程</li>
<li>最后一步，将上述签名后的apk通过zipalign进行优化，以提高加载和运行速度。大概原理是通过对其中包含的相关数据进行边界对齐，来加快读取和处理。这也同时解释了其名称&quot;zip&quot;+&quot;align”的由来</li>
</ul>
<p>      好在android sdk tools中已经将ant编译脚本写好了，只要直接调用就可以了。</p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2014-10-13-%E4%B8%8B%E5%8D%881.28.07.png" alt="屏幕快照 2014 10 13 下午1 28 07" title="屏幕快照 2014-10-13 下午1.28.07.png"></p>
<p>     项目中build.xml内容,这里只定义了一个target，在编译完成后在手机上自动运行一个app，此build.xml在能用的python脚本里会调用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xmlversion=&#34;1.0&#34;encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="color:#f92672">&lt;project</span>
    <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;sanguo&#34;</span>
    <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;sanguoBuildAll&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;propertyfile</span><span style="color:#960050;background-color:#1e0010">=&#34;ant.properties&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;loadpropertiessrcFile</span><span style="color:#960050;background-color:#1e0010">=&#34;project.properties&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;targetname</span><span style="color:#960050;background-color:#1e0010">=&#34;apkBuildBefore&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;echomessage</span><span style="color:#960050;background-color:#1e0010">=&#34;apk</span> <span style="color:#960050;background-color:#1e0010">build</span> <span style="color:#960050;background-color:#1e0010">before</span> <span style="color:#960050;background-color:#1e0010">....&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/target&gt;</span>
    <span style="color:#f92672">&lt;targetname</span><span style="color:#960050;background-color:#1e0010">=&#34;runApp&#34;</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;exec</span>
<span style="color:#a6e22e">executable=</span><span style="color:#e6db74">&#34;adb&#34;</span> <span style="color:#f92672">&gt;</span>
                <span style="color:#f92672">&lt;argline</span><span style="color:#960050;background-color:#1e0010">=&#34;shell</span> <span style="color:#960050;background-color:#1e0010">am</span> <span style="color:#960050;background-color:#1e0010">start</span> <span style="color:#960050;background-color:#1e0010">-n</span> <span style="color:#960050;background-color:#1e0010">com.sanguo.game.uc/com.sanguo.game.uc.sanguo&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/exec&gt;</span>
    <span style="color:#f92672">&lt;/target&gt;</span>
    <span style="color:#f92672">&lt;propertyname</span><span style="color:#960050;background-color:#1e0010">=&#34;common.buildxml&#34;</span><span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;../tools/build/build_common_android.xml&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--导入共用build--&gt;</span>
    <span style="color:#f92672">&lt;importfile</span><span style="color:#960050;background-color:#1e0010">=&#34;${common.buildxml}&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/project&gt;</span>
</code></pre></div><p>tools目录中公用的build_common_android.xml内容,些ant主要任务是替换版本号(用到了xmltask库),编译android项目并运行.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xmlversion=&#34;1.0&#34;encoding=&#34;UTF-8&#34;?&gt;</span>
<span style="color:#f92672">&lt;projectname</span><span style="color:#960050;background-color:#1e0010">=&#34;commonBuild&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;taskdefname</span><span style="color:#960050;background-color:#1e0010">=&#34;xmltask&#34;</span><span style="color:#a6e22e">classname=</span><span style="color:#e6db74">&#34;com.oopsconsultancy.xmltask.ant.XmlTask&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;propertyenvironment</span><span style="color:#960050;background-color:#1e0010">=&#34;env&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--&lt;property name=&#34;project.versionname&#34; value=&#34;1&#34; /&gt;
</span><span style="color:#75715e">&lt;property name=&#34;project.versioncode&#34; value=&#34;1&#34; /&gt;
</span><span style="color:#75715e">--&gt;</span>
    <span style="color:#f92672">&lt;propertyname</span><span style="color:#960050;background-color:#1e0010">=&#34;manifest.file&#34;</span><span style="color:#a6e22e">location=</span><span style="color:#e6db74">&#34;${basedir}/AndroidManifest.xml&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;echomessage</span><span style="color:#960050;background-color:#1e0010">=&#34;build</span> <span style="color:#960050;background-color:#1e0010">project</span> <span style="color:#960050;background-color:#1e0010">path</span> <span style="color:#960050;background-color:#1e0010">is</span> <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#960050;background-color:#1e0010">${basedir}&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;echomessage</span><span style="color:#960050;background-color:#1e0010">=&#34;AndroidManifest.xml</span> <span style="color:#960050;background-color:#1e0010">path</span> <span style="color:#960050;background-color:#1e0010">is</span> <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#960050;background-color:#1e0010">${manifest.file}&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;condition</span>
<span style="color:#a6e22e">property=</span><span style="color:#e6db74">&#34;sdk.dir&#34;</span>
        <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;${env.ANDROID_HOME}&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;issetproperty</span><span style="color:#960050;background-color:#1e0010">=&#34;env.ANDROID_HOME&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/condition&gt;</span>
<span style="color:#f92672">&lt;fail</span>
        <span style="color:#a6e22e">message=</span><span style="color:#e6db74">&#34;sdk.dir missing, please config  ANDROID_HOME environment variable.&#34;</span>
<span style="color:#a6e22e">unless=</span><span style="color:#e6db74">&#34;sdk.dir&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--完整编译--&gt;</span>
    <span style="color:#f92672">&lt;target</span>
        <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;sanguoBuildAll&#34;</span>
        <span style="color:#a6e22e">depends=</span><span style="color:#e6db74">&#34;sanguoBuildNotInstall,intallSanguo&#34;</span>
        <span style="color:#a6e22e">description=</span><span style="color:#e6db74">&#34;install sanguo application&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--完整编译但是不安装--&gt;</span>
    <span style="color:#f92672">&lt;target</span>
        <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;sanguoBuildNotInstall&#34;</span>
        <span style="color:#a6e22e">depends=</span><span style="color:#e6db74">&#34;replace_manifest,apkBuildBefore,clean,release&#34;</span>
        <span style="color:#a6e22e">description=</span><span style="color:#e6db74">&#34;install sanguo application&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--安装并运行--&gt;</span>
    <span style="color:#f92672">&lt;target</span>
        <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;intallSanguo&#34;</span>
        <span style="color:#a6e22e">depends=</span><span style="color:#e6db74">&#34;installr,runApp&#34;</span>
        <span style="color:#a6e22e">description=</span><span style="color:#e6db74">&#34;install sanguo application&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#75715e">&lt;!--替换版本--&gt;</span>
    <span style="color:#f92672">&lt;targetname</span><span style="color:#960050;background-color:#1e0010">=&#34;replace_manifest_check&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;conditionproperty</span><span style="color:#960050;background-color:#1e0010">=&#34;has.version&#34;</span><span style="color:#f92672">&gt;</span>
             <span style="color:#f92672">&lt;issetproperty</span><span style="color:#960050;background-color:#1e0010">=&#34;project.versionname&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;/condition&gt;</span>
    <span style="color:#f92672">&lt;/target&gt;</span>
    <span style="color:#f92672">&lt;targetname</span><span style="color:#960050;background-color:#1e0010">=&#34;replace_manifest&#34;</span><span style="color:#a6e22e">if=</span><span style="color:#e6db74">&#34;has.version&#34;</span><span style="color:#a6e22e">depends=</span><span style="color:#e6db74">&#34;replace_manifest_check&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;xmltasksource</span><span style="color:#960050;background-color:#1e0010">=&#34;${manifest.file}&#34;</span><span style="color:#a6e22e">dest=</span><span style="color:#e6db74">&#34;${manifest.file}&#34;</span><span style="color:#a6e22e">encoding=</span><span style="color:#e6db74">&#34;utf-8&#34;</span><span style="color:#f92672">&gt;</span>
            <span style="color:#f92672">&lt;attrpath</span><span style="color:#960050;background-color:#1e0010">=&#34;//manifest&#34;</span><span style="color:#a6e22e">attr=</span><span style="color:#e6db74">&#34;android:versionName&#34;</span><span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;${project.versionname}&#34;</span><span style="color:#f92672">/&gt;</span>
            <span style="color:#f92672">&lt;attrpath</span><span style="color:#960050;background-color:#1e0010">=&#34;//manifest&#34;</span><span style="color:#a6e22e">attr=</span><span style="color:#e6db74">&#34;android:versionCode&#34;</span><span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;${project.versioncode}&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/xmltask&gt;</span>
        <span style="color:#f92672">&lt;echomessage</span><span style="color:#960050;background-color:#1e0010">=&#34;new</span> <span style="color:#960050;background-color:#1e0010">version</span> <span style="color:#960050;background-color:#1e0010">is:</span> <span style="color:#960050;background-color:#1e0010">${project.versionname}</span> <span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">${project.versioncode}&#34;</span><span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;echomessage</span><span style="color:#960050;background-color:#1e0010">=&#34;replace_manifest</span> <span style="color:#960050;background-color:#1e0010">version</span> <span style="color:#960050;background-color:#1e0010">code</span> <span style="color:#960050;background-color:#1e0010">success</span> <span style="color:#960050;background-color:#1e0010">....&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/target&gt;</span>
    <span style="color:#f92672">&lt;importfile</span><span style="color:#960050;background-color:#1e0010">=&#34;${sdk.dir}/tools/ant/build.xml&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/project&gt;</span>
</code></pre></div><p><strong>IOS项目的编译过程</strong></p>
<p><strong>xcode打包过程</strong></p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/xcodebuild2.jpg" alt="Xcodebuild" title="xcodebuild.jpg"></p>
<ul>
<li>
<p>编译源文件（Compile Sources）连接二进制文件和库（Link Binary With Libraries）<br>
这个阶段编译所有的源文件；默认情况下，项目中添加任何一个源文件，也将添加到编译列表中。<br>
Compile Sources 构建阶段分为两步：预处理（Preprocessing）和编译（Compiling）。<br>
<code>预处理（Preprocessing）</code><br>
的目标是为每一个实现文件（.m）创建中间文件（intermediate file）。中间文件仍然类似实现文件的Objective-C代码，但是中间文件会变得非常大。<br>
在创建中间文件时，预处理器负责处理实现文件（.m）中所有的预处理指令（preprocessor directives）。预处理指令是所有以 # 开头的语句，如 #import。#import 语句将替换为实际引用文件的内容。<br>
例如，一个实现文件 .m 引用了.h 头文件；为 .m 创建的中间文件将包含 .h和 .m文件。还不止这些，并且 .h 头文件引用了其他 2 个文件 UIKit.h和CoreLocation.h，还有可能这 2 个文件引用了其他的头文件 .h，这些头文件将全部包含在该实现文件.m    创建的中间文件中（intermediate file）。<br>
<code>编译（Compiling）</code><br>
一旦预编译（Preprocessor）完成之后，接着编译生成的中间文件（intermediate files），编译中间文件 – Objective-C 代码，生成机器码（machine code）。机器码存放在对象文件（object file）中，一个中间文件对应一个对象文件。<br>
编译阶段，也就是将Objective代码文件转为机器码，将检测多数编译错误。当编译器不理解我们编写的代码时，将报错。我们称之为编译错误或语法错误。<br>
<code>连接（Linking）</code><br>
编译生成的对象文件（object file）包含了实现文件（implementation file）的机器码。在一个实现文件中，可以调用其他实现文件的方法。此时，并不会将其他实现文件的代码复制到本实现文件中，而是连接其他实现文件。连接二进制文件和库（Link Binary With Libraries）就是负责此项任务，我们简称连接阶段（linking phase）。</p>
</li>
<li>
<p>复制绑定资源（Copy Bundle Resources）<br>
在源文件编译和连接库之后，创建一个可执行文件，并放置在应用程序的绑定中，其实就是一个文件夹。<br>
其中资源文件将和可执行文件一起添加到绑定（bundle）中。这些资源文件是数据文件，应用程序在运行时需要使用，如XIB 文件和图像文件、声音文件等等。<br>
默认情况下，添加到项目中的文件，如不是源代码文件，将添加到这个构建阶段（Build Phase）。<br>
如果图片资源是PNG格式，那么不仅仅对其进行拷贝，还会做一些优化(如果build settings中的PNG优化是打开的)</p>
</li>
<li>
<p>运行指定脚本
如果在build phases 下指定了run Script,在这里会运行脚本。
我在项目中的脚本内容如下</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">_TARGET_BUILD_CONTENTS_PATH<span style="color:#f92672">=</span>$TARGET_BUILD_DIR/$CONTENTS_FOLDER_PATH
echo Target Path: $_TARGET_BUILD_CONTENTS_PATH
BUILD_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/../tools/build/build_native.py
python $BUILD_PATH -c 2  -w <span style="color:#ae81ff">0</span> -o $_TARGET_BUILD_CONTENTS_PATH
</code></pre></div><ul>
<li>打包签名
调用command tools打包签名</li>
</ul>
<p><strong>脚本打包</strong></p>
<p>脚本打包一般采用xcodebuild和xcrun.</p>
<p>这里在github中有一个用它打包的shell库,包括了打包上传邮件通知，功能比较完整(<a href="https://github.com/webfrogs/xcode_shell">https://github.com/webfrogs/xcode_shell</a>)</p>
<p>xcodebuild这种打包方式缺点是编译过程中输出太不人性化，难以查看，所以我找了facebook开源的的一个打包的库xctool.</p>
<p>打包脚本build_ipa_all.sh如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e">#--------------------------------------------</span>
<span style="color:#75715e"># 功能：编译xcode项目并打ipa包</span>
<span style="color:#75715e"># 使用说明：</span>
<span style="color:#75715e"># 编译workspace</span>
<span style="color:#75715e">#build_ipa_all   proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sangup91  140902</span>
<span style="color:#75715e"># 作者：farwmarth</span>
<span style="color:#75715e"># E-mail:[wujiyu115@gmail.com](mailto:wujiyu115@gmail.com)</span>
<span style="color:#75715e"># 创建日期：2014-09-23 15:17:19</span>
<span style="color:#75715e">#--------------------------------------------</span>
<span style="color:#75715e">#build前清除之前的目录</span>
clean_app_build_dic<span style="color:#f92672">=</span>true
<span style="color:#75715e">#是否只通过*.app来生成ipa</span>
only_packge_ipa<span style="color:#f92672">=</span>false
<span style="color:#75715e">##############配置工程目录和scheme名称,scheme名称要和xcodeproj一致,用空格隔开#############</span>
<span style="color:#75715e">#要打包的项目</span>
project_config<span style="color:#f92672">=</span>$1
<span style="color:#75715e">#新版本</span>
new_version_code<span style="color:#f92672">=</span>$2
<span style="color:#75715e">#去空格</span>
new_version_code<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $new_version_code<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span>  <span style="color:#f92672">[[</span> ! $new_version_code <span style="color:#f92672">=</span>~ ^<span style="color:#f92672">[</span>0-9<span style="color:#f92672">]</span>+$ <span style="color:#f92672">]]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">${#</span>new_version_code<span style="color:#e6db74">}</span> -ne <span style="color:#ae81ff">6</span> <span style="color:#f92672">]</span>  ; <span style="color:#66d9ef">then</span>
echo new_version_code is not number or the length is not six
exit2
<span style="color:#66d9ef">fi</span>
<span style="color:#75715e">################################</span>
str_dic<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
str_scheme<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> item in <span style="color:#66d9ef">$(</span>echo $project_config | tr <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">do</span>
  count<span style="color:#f92672">=</span>1
<span style="color:#66d9ef">for</span> config in <span style="color:#66d9ef">$(</span>echo $item | tr <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">do</span>
<span style="color:#75715e"># echo $count</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>;<span style="color:#66d9ef">then</span>
str_dic<span style="color:#f92672">=</span>$str_dic<span style="color:#e6db74">&#34; &#34;</span>$config
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $count <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span> ;<span style="color:#66d9ef">then</span>
str_scheme<span style="color:#f92672">=</span>$str_scheme<span style="color:#e6db74">&#34; &#34;</span>$config
<span style="color:#66d9ef">fi</span>
let <span style="color:#e6db74">&#34;count++&#34;</span>
<span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">done</span>
echo $str_dic
echo $str_scheme
dicArray<span style="color:#f92672">=(</span>$str_dic<span style="color:#f92672">)</span>
schemeArray<span style="color:#f92672">=(</span>$str_scheme<span style="color:#f92672">)</span>
<span style="color:#75715e"># exit 0</span>
<span style="color:#75715e">#############安装brew 和xctool#############</span>
<span style="color:#66d9ef">if</span> which brew 2&amp;gt;/dev/null; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;brew exists!&#34;</span>
<span style="color:#66d9ef">else</span>
  echo <span style="color:#e6db74">&#34;nope, no brew installed, begin install&#34;</span>
  curl -LsSf http://github.com/mxcl/homebrew/tarball/master | sudo tar xvz -C/usr/local --strip 1
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> which xctool&amp;gt;/dev/null; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;xctool exists!&#34;</span>
<span style="color:#66d9ef">else</span>
  echo <span style="color:#e6db74">&#34;nope, no xctool installed, begin install&#34;</span>
  sudo brew update
  sudo brew install xctool
<span style="color:#66d9ef">fi</span>
<span style="color:#75715e"># xctool -scheme sanguopp -reporter plain:log.txt  archive  -archivePath ./xctoolBuild</span>
<span style="color:#75715e">#############批量打包应用#############</span>
dic_count<span style="color:#f92672">=</span><span style="color:#e6db74">${#</span>dicArray[@]<span style="color:#e6db74">}</span>
scheme_count<span style="color:#f92672">=</span><span style="color:#e6db74">${#</span>schemeArray[@]<span style="color:#e6db74">}</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> dic_count!<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> &amp;amp;&amp;amp; <span style="color:#f92672">[</span> $dic_count !<span style="color:#f92672">=</span> $scheme_count <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
echo <span style="color:#e6db74">&#34;dic count not equesl scheme count!&#34;</span>
exit2
<span style="color:#66d9ef">fi</span>
build_path<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>
ios_build_path<span style="color:#f92672">=</span>$build_path/releaseIpas
ios_ipa_build_path<span style="color:#f92672">=</span>$build_path/releaseIpas/ipabuild
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $clean_app_build_dic  <span style="color:#f92672">]</span> &amp;amp;&amp;amp; <span style="color:#f92672">[</span> -d $ios_build_path <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
rm -rf $ios_build_path
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d $ios_ipa_build_path <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
mkdir -p $ios_ipa_build_path
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">function</span> replace_info_list<span style="color:#f92672">(){</span>
app_infoplist_path<span style="color:#f92672">=</span>$1
schemeName<span style="color:#f92672">=</span>$2
<span style="color:#75715e">#取版本号</span>
bundleShortVersion<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>/usr/libexec/PlistBuddy -c <span style="color:#e6db74">&#34;print CFBundleShortVersionString&#34;</span> <span style="color:#e6db74">${</span>app_infoplist_path<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
<span style="color:#75715e">#取build值</span>
bundleVersion<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>/usr/libexec/PlistBuddy -c <span style="color:#e6db74">&#34;print CFBundleVersion&#34;</span> <span style="color:#e6db74">${</span>app_infoplist_path<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
hasPoint<span style="color:#f92672">=</span>false
temp_version_code<span style="color:#f92672">=</span>$new_version_code
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $bundleShortVersion <span style="color:#f92672">=</span>~ <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">]]</span>;<span style="color:#66d9ef">then</span>
    hasPoint<span style="color:#f92672">=</span>true
<span style="color:#66d9ef">else</span>
hasPoint<span style="color:#f92672">=</span>false
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$hasPoint<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> true <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
temp_version_code<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo  $temp_version_code|awk  <span style="color:#e6db74">&#39;BEGIN{FS=&#34;&#34;}{print $1$2&#34;.&#34;$3$4&#34;.&#34;$5$6}&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">fi</span>
echo $schemeName old CFBundleShortVersionString,CFBundleVersion is: $bundleShortVersion , $bundleVersion
echo $schemeName ipa new_version_code is: $temp_version_code
    /usr/libexec/Plistbuddy -c <span style="color:#e6db74">&#34;Set CFBundleVersion </span>$temp_version_code<span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">${</span>app_infoplist_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    /usr/libexec/Plistbuddy -c <span style="color:#e6db74">&#34;Set CFBundleShortVersionString </span>$temp_version_code<span style="color:#e6db74">&#34;&#34;</span><span style="color:#e6db74">${</span>app_infoplist_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">function</span> build_release<span style="color:#f92672">(){</span>
schemeName<span style="color:#f92672">=</span>$2
project_path<span style="color:#f92672">=</span>$1/$scheme<span style="color:#e6db74">&#34;.xcodeproj&#34;</span>
<span style="color:#75715e">#app文件中Info.plist文件路径</span>
app_infoplist_path<span style="color:#f92672">=</span>$1/Info.plist
<span style="color:#75715e">#ipa名称</span>
ipa_name<span style="color:#f92672">=</span>$schemeName<span style="color:#e6db74">&#34;_&#34;</span><span style="color:#66d9ef">$(</span>date +<span style="color:#e6db74">&#34;%Y%m%d&#34;</span><span style="color:#66d9ef">)</span>
<span style="color:#75715e">#scheme路径</span>
target_ios_build_path<span style="color:#f92672">=</span>$ios_build_path/$schemeName
<span style="color:#75715e">#生成.app的路径</span>
target_ios_app_path<span style="color:#f92672">=</span>$target_ios_build_path<span style="color:#e6db74">&#34;.xcarchive/Products/Applications/*.app&#34;</span>
<span style="color:#75715e">#发布的ipa路径</span>
ipa_publish_path<span style="color:#f92672">=</span>$ios_ipa_build_path/<span style="color:#e6db74">${</span>ipa_name<span style="color:#e6db74">}</span>.ipa
replace_info_list $app_infoplist_path $schemeName
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>  <span style="color:#e6db74">&#34;</span>$only_packge_ipa<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> false <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
echo  xctool build begin...
xctool -project $project_path -scheme $schemeName clean
xctool -project $project_path -scheme $schemeName archive  -archivePath $target_ios_build_path
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d $target_ios_app_path <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
xcrun -sdk iphoneos PackageApplication -v $target_ios_app_path -o  $ipa_publish_path
<span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">for</span> <span style="color:#f92672">((</span> i<span style="color:#f92672">=</span>0;i&amp;lt;$dic_count;i<span style="color:#f92672">=</span>i+1<span style="color:#f92672">))</span>
<span style="color:#66d9ef">do</span>
dic<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>dicArray[$i]<span style="color:#e6db74">}</span>
scheme<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>schemeArray[$i]<span style="color:#e6db74">}</span>
p_path<span style="color:#f92672">=</span>../../$dic
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d $p_path <span style="color:#f92672">]</span> ; <span style="color:#66d9ef">then</span>
build_release $p_path $scheme
<span style="color:#66d9ef">else</span>
echo <span style="color:#e6db74">&#34;this project is not exists :&#34;</span>$p_path
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>脚本使用方法 build_ipa_all   proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sangup91  140902
第一个参数:工程目录名#要编译的scheme名:工程目录名#要编译的scheme名
第二个参数:新版本名
如果没有xctool，脚本会自动安装,然后调用PlistBuddy替换版本号，然后调用xctool打包。
编译所有ios项目的脚本build_ipa_all.sh:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"> <span style="color:#75715e">#!/bin/bash</span>
newVersion<span style="color:#f92672">=</span>140902
allproj<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sanguo91:proj.ios_xy#sanguoXY&#39;</span>
python build_native.py -c 2  -w 0
. ./build_common_ipa.sh $allproj $newVersion 
</code></pre></div><p> </p>
<p>最后来看下android和iOS公用的python脚本build_native.py: </p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#75715e">#!/usr/bin/python</span>
<span style="color:#75715e"># build_native.py</span>
<span style="color:#75715e"># Build native codes</span>
<span style="color:#75715e">#--------------------------------------------</span>
<span style="color:#75715e"># 功能：加密处理资源</span>
<span style="color:#75715e"># 使用说明：</span>
<span style="color:#75715e">#   &#39;-c&#39;, &#39;--compiler_platform&#39;, dest=&#39;compiler_platform&#39;, help=&#39;编译android用1,编译ipa用2&#39;)</span>
<span style="color:#75715e">#   &#39;-p&#39;, &#39;--projects_path&#39;, dest=&#39;projects_path&#39;, help=&#39;项目目录名,如proj.android,编译ipa单个项目时可不指定,为空值时不调用xctool脚本打包&#39;)</span>
<span style="color:#75715e">#   &#39;-w&#39;, &#39;--with_lua_code&#39;, dest=&#39;with_lua_code&#39;, help=&#39;1为带源lua源码,0为加密lua代码&#39;)</span>
<span style="color:#75715e">#   &#39;-t&#39;, &#39;--ant_target&#39;, dest=&#39;ant_target&#39;, help=&#39;编译android时 为&#34;None&#34;值:不调用build.xml,为空值时调用默认的target,有值时调用对应的ant target&#39;)</span>
<span style="color:#75715e">#   &#39;-s&#39;, &#39;--compiler_cplus&#39;, dest=&#39;compiler_cplus&#39;, help=&#39;调用ndk编译c++代码，编译ipa时无用&#39;)</span>
<span style="color:#75715e">#   &#39;-v&#39;, &#39;--version_code&#39;, dest=&#39;version_code&#39;, help=&#39;新的版本号&#39;)</span>
<span style="color:#75715e">#   &#39;-o&#39;, &#39;--output_path&#39;, dest=&#39;output_path&#39;, help=&#39;资源加密后输出目录,可选&#39;)</span>
<span style="color:#75715e"># 作者：farwmarth</span>
<span style="color:#75715e"># E-mail:[wujiyu115@gmail.com](mailto:wujiyu115@gmail.com)</span>
<span style="color:#75715e"># 创建日期：2014-09-23 15:17:19</span>
<span style="color:#75715e">#--------------------------------------------</span>
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> os<span style="color:#f92672">,</span> os.path<span style="color:#f92672">,</span> stat<span style="color:#f92672">,</span> shutil
<span style="color:#f92672">import</span> shutil
<span style="color:#f92672">import</span> platform
<span style="color:#f92672">from</span> optparse <span style="color:#f92672">import</span> OptionParser
PLATFORM_ANDROID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span>
PLATFORM_IOS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>
SO_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/libs/armeabi/libcocos2dlua.so&#34;</span>
ANDROID_PROJ_BASE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proj.android.base&#34;</span>
PROJ_SO_BASE<span style="color:#f92672">=</span>ANDROID_PROJ_BASE<span style="color:#f92672">+</span>SO_PATH
CURR_DIR <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(__file__))
releaseApksFile <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(CURR_DIR<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/releaseApks/&#34;</span>)
ANT_PATH<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(CURR_DIR)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/../ant/bin/ant&#34;</span>)
with_lua_code <span style="color:#f92672">=</span> False  <span style="color:#75715e"># 是否运行lua源码</span>
compiler_cplus <span style="color:#f92672">=</span> False  <span style="color:#75715e"># android上是否编译c++代码</span>
compiler_platform <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># 编译的平台 android还是ios</span>
projects_path <span style="color:#f92672">=</span>None  <span style="color:#75715e"># 项目要目录 </span>
ant_target <span style="color:#f92672">=</span> None<span style="color:#75715e"># android ant 目标</span>
version_code <span style="color:#f92672">=</span> None <span style="color:#75715e"># 新版本号</span>
output_path <span style="color:#f92672">=</span> None <span style="color:#75715e">#资源处理好后输出目录</span>
<span style="color:#75715e"># 检查ndk环境变量</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_ndk_environment</span>():
    <span style="color:#e6db74">&#39;&#39;&#39; Checking the environment NDK_ROOT, which will be used for building
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
    <span style="color:#66d9ef">try</span>:
        NDK_ROOT <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;NDK_ROOT&#39;</span>]
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;NDK_ROOT not defined. Please define NDK_ROOT in your environment&#34;</span>
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> NDK_ROOT
<span style="color:#75715e">#检查环境变量</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_environment_variables</span>():
    <span style="color:#66d9ef">if</span> compiler_platform<span style="color:#f92672">==</span>PLATFORM_ANDROID :
        svnResult <span style="color:#f92672">=</span> None
        antResult <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">if</span>(isWin32()):
            svnResult <span style="color:#f92672">=</span> check_cmd_path(<span style="color:#e6db74">&#34;TortoiseProc.exe&#34;</span>)
            antResult <span style="color:#f92672">=</span> check_cmd_path(<span style="color:#e6db74">&#34;ant&#34;</span>)
        <span style="color:#66d9ef">else</span>:
            svnResult <span style="color:#f92672">=</span> check_cmd_path(<span style="color:#e6db74">&#34;svn&#34;</span>)
            antResult <span style="color:#f92672">=</span> check_cmd_path(<span style="color:#e6db74">&#34;ant&#34;</span>)
        <span style="color:#75715e"># print svnResult</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> svnResult :
            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
<span style="color:#75715e">#检查路径里面是否包含某可执行文件</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_cmd_path</span>(executePath):
    result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    dirs <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">if</span>(isWin32()):
        dirs <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;PATH&#39;</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;;&#39;</span>)
    <span style="color:#66d9ef">else</span>:
        dirs <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;PATH&#39;</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;:&#39;</span>)
    <span style="color:#66d9ef">for</span> cmdpath <span style="color:#f92672">in</span> dirs :
        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(cmdpath) <span style="color:#f92672">and</span>  executePath <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(cmdpath):
            result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> result:
         <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;please check environment variables   &#34;</span> <span style="color:#f92672">+</span> executePath
    <span style="color:#66d9ef">return</span> result
<span style="color:#75715e"># ndk编译链</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">select_toolchain_version</span>():
    <span style="color:#e6db74">&#39;&#39;&#39;ndk-r8e  -&amp;gt; use gcc4.7
</span><span style="color:#e6db74">    ndk-r9   -&amp;gt; use gcc4.8
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
    ndk_root <span style="color:#f92672">=</span> check_ndk_environment()
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(ndk_root, <span style="color:#e6db74">&#34;toolchains/arm-linux-androideabi-4.8&#34;</span>)):
        os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;NDK_TOOLCHAIN_VERSION&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.8&#39;</span>
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;The Selected NDK toolchain version was 4.8 !&#34;</span>
    <span style="color:#66d9ef">elif</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(ndk_root, <span style="color:#e6db74">&#34;toolchains/arm-linux-androideabi-4.7&#34;</span>)):
        os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;NDK_TOOLCHAIN_VERSION&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4.7&#39;</span>
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;The Selected NDK toolchain version was 4.7 !&#34;</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;Couldn&#39;t find the gcc toolchain.&#34;</span>
        exit(<span style="color:#ae81ff">1</span>)
<span style="color:#75715e"># ndk编译c++</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_build</span>(cocos_root, ndk_root, app_android_root):
    ndk_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(ndk_root, <span style="color:#e6db74">&#34;ndk-build&#34;</span>)
    <span style="color:#75715e"># windows should use &#34;;&#34; to seperate module paths</span>
    platform <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>platform
    <span style="color:#66d9ef">if</span> platform <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;win32&#39;</span>:
        ndk_module_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NDK_MODULE_PATH=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">/cocos2dx/platform/third_party/android/prebuilt&#39;</span> <span style="color:#f92672">%</span> (cocos_root, cocos_root)
    <span style="color:#66d9ef">else</span>:
        ndk_module_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NDK_MODULE_PATH=</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">/cocos2dx/platform/third_party/android/prebuilt&#39;</span> <span style="color:#f92672">%</span> (cocos_root, cocos_root)
    command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> -C </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (ndk_path, app_android_root, ndk_module_path)
    os<span style="color:#f92672">.</span>system(command)
<span style="color:#75715e"># 赋权操作</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">subFileChmod</span>(_sPath, _stat):
     itemsInDir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(_sPath);
     <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> itemsInDir:
         sItemPath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(_sPath, item);
         os<span style="color:#f92672">.</span>chmod(sItemPath, _stat);
         <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(sItemPath):
             subFileChmod(sItemPath, _stat);
<span style="color:#75715e"># 拷贝文件</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">copy_files</span>(src, dst):
    <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(src):
        path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(src, item)
        <span style="color:#75715e"># Android can not package the file that ends with &#34;.gz&#34;</span>
        <span style="color:#66d9ef">if</span> with_lua_code <span style="color:#f92672">==</span> False:
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;UserDefault.xml&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.gz&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.dll&#39;</span>)  <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.exe&#39;</span>)  <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;start.bat&#39;</span>) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
                shutil<span style="color:#f92672">.</span>copy(path, dst)
            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.svn&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;script&#39;</span>) <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;cache&#39;</span> <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;editor&#39;</span>  <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.settings&#39;</span>  <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;_gsdata_&#39;</span>  :
                new_dst <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dst, item)
                <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(new_dst):
                    shutil<span style="color:#f92672">.</span>rmtree(new_dst)
                os<span style="color:#f92672">.</span>mkdir(new_dst)
                copy_files(path, new_dst)
        <span style="color:#66d9ef">else</span> :
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;UserDefault.xml&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.gz&#39;</span>) <span style="color:#f92672">and</span>  <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.dll&#39;</span>)  <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.exe&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;start.bat&#39;</span>) <span style="color:#f92672">and</span>  item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;js&#39;</span> <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
                shutil<span style="color:#f92672">.</span>copy(path, dst)
            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> item<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.svn&#39;</span>) <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;cache&#39;</span> <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;editor&#39;</span>  <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.settings&#39;</span> <span style="color:#f92672">and</span> item <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;_gsdata_&#39;</span>  :
                new_dst <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dst, item)
                <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(new_dst):
                    shutil<span style="color:#f92672">.</span>rmtree(new_dst)
                os<span style="color:#f92672">.</span>mkdir(new_dst)
                copy_files(path, new_dst)
<span style="color:#75715e"># 拷贝资源</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">copy_resources</span>(resources_dir,assets_dir,remove_assets):
    <span style="color:#66d9ef">if</span> remove_assets:
        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(assets_dir):
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;delete &#34;</span><span style="color:#f92672">+</span>assets_dir
            shutil<span style="color:#f92672">.</span>rmtree(assets_dir)
        os<span style="color:#f92672">.</span>mkdir(assets_dir)
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(resources_dir):
        copy_files(resources_dir, assets_dir)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">copy_android_res</span>(app_android_root):
    assets_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app_android_root, <span style="color:#e6db74">&#34;assets&#34;</span>)
    resources_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app_android_root, <span style="color:#e6db74">&#34;../Resources&#34;</span>)
    <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(resources_dir) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(assets_dir):
        copy_resources(resources_dir,assets_dir,True)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">copy_ipa_res</span>(app_output_path,resources_dir):
    <span style="color:#66d9ef">if</span> app_output_path<span style="color:#f92672">!=</span>None <span style="color:#f92672">and</span> resources_dir<span style="color:#f92672">!=</span>None <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(app_output_path) <span style="color:#f92672">and</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(resources_dir):
        copy_resources(resources_dir,app_output_path,False)
    <span style="color:#66d9ef">pass</span>
<span style="color:#75715e"># 加密lua代码</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dumplua</span>(current_dir):
    <span style="color:#66d9ef">if</span> with_lua_code <span style="color:#f92672">==</span> False:
        command <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">if</span>(isWin32()):
            command <span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(current_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/../dump/dump.bat&#34;</span>)
            command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;call &#34;</span><span style="color:#f92672">+</span>command
        <span style="color:#66d9ef">else</span>:
            command <span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(current_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/../dump/dump.sh&#34;</span>)
        <span style="color:#66d9ef">if</span> command :
            <span style="color:#75715e"># print command</span>
            os<span style="color:#f92672">.</span>system(command)
<span style="color:#75715e"># 是否是windows平台</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">isWin32</span>():
    sysstr <span style="color:#f92672">=</span> platform<span style="color:#f92672">.</span>system()
    <span style="color:#66d9ef">return</span> sysstr <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Windows&#34;</span>
<span style="color:#75715e">#更新so文件</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">updateSo</span>(update,app_android_root):
    <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;update so file&#34;</span>
    <span style="color:#75715e"># print update</span>
    command <span style="color:#f92672">=</span>None
    PROJ_SO_BASE_ABS <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(app_android_root<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/../&#34;</span><span style="color:#f92672">+</span>PROJ_SO_BASE)
    <span style="color:#75715e"># print PROJ_SO_BASE_ABS</span>
    <span style="color:#66d9ef">if</span> update <span style="color:#f92672">==</span>True :
        <span style="color:#66d9ef">if</span>(isWin32()):
            command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;TortoiseProc.exe /command:update /path:&#34;</span><span style="color:#f92672">+</span>PROJ_SO_BASE_ABS<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; /closeonend:1&#34;</span>
        <span style="color:#66d9ef">else</span>:
            command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;svn update &#34;</span><span style="color:#f92672">+</span>PROJ_SO_BASE_ABS
        os<span style="color:#f92672">.</span>system(command)
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;update so file success&#34;</span>
    <span style="color:#66d9ef">pass</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">outputApk</span>(app_android_root,project_path):
    <span style="color:#66d9ef">if</span> ant_target <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;None&#34;</span>:
        <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;.................outputApk&#34;</span>
        command<span style="color:#f92672">=</span> ANT_PATH<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;  -buildfile  &#34;</span> <span style="color:#f92672">+</span> app_android_root<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/build.xml  &#34;</span>
        <span style="color:#66d9ef">if</span> ant_target:
            <span style="color:#66d9ef">if</span> ant_target <span style="color:#f92672">==</span><span style="color:#e6db74">&#34;sanguoBuildNotInstall&#34;</span>:
                command <span style="color:#f92672">=</span>command <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -q &#34;</span>
            command <span style="color:#f92672">=</span> command<span style="color:#f92672">+</span>ant_target
        <span style="color:#66d9ef">if</span> version_code:
            command <span style="color:#f92672">=</span> command<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; -Dproject.versionname=&#34;</span><span style="color:#f92672">+</span>version_code<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; -Dproject.versioncode=&#34;</span><span style="color:#f92672">+</span>version_code
        <span style="color:#66d9ef">print</span> command
        <span style="color:#66d9ef">if</span> command :
            os<span style="color:#f92672">.</span>system(command)
        <span style="color:#66d9ef">if</span> ant_target <span style="color:#f92672">==</span><span style="color:#e6db74">&#34;sanguoBuildNotInstall&#34;</span>:
            releaseApk <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(app_android_root<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/bin/sanguo-release.apk&#34;</span>)
            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(releaseApk):
                destPath<span style="color:#f92672">=</span>releaseApksFile<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>project_path<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.apk&#34;</span>
                <span style="color:#75715e"># print destPath</span>
                shutil<span style="color:#f92672">.</span>copy(releaseApk,destPath)
                <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;copy  &#34;</span><span style="color:#f92672">+</span>project_path<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; apk success&#34;</span>
    <span style="color:#66d9ef">pass</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">outputIpa</span>(app_projects_path):
    <span style="color:#66d9ef">if</span>  app_projects_path <span style="color:#f92672">!=</span> None:
        command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;. ./build_common_ipa.sh  &#34;</span><span style="color:#f92672">+</span>app_projects_path
        os<span style="color:#f92672">.</span>system(command)
<span style="color:#75715e"># 处理</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build</span>() :
    <span style="color:#75715e"># check_environment_variables</span>
    check_environment_variables()
    <span style="color:#75715e"># set Path</span>
    current_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(__file__))
    cocos_root <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(current_dir, <span style="color:#e6db74">&#34;../../../..&#34;</span>)
    <span style="color:#75715e"># dumpLua</span>
    dumplua(current_dir)
    <span style="color:#66d9ef">if</span> compiler_platform<span style="color:#f92672">==</span>PLATFORM_ANDROID :
        <span style="color:#75715e">#如果在函数内修改全局变量则视他为一个局部变量</span>
        projects_path_local <span style="color:#f92672">=</span> projects_path<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)
        projectLen<span style="color:#f92672">=</span>len(projects_path_local)
        ANDROID_PROJ_BASE_ABS<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(current_dir, <span style="color:#e6db74">&#34;../../&#34;</span>) <span style="color:#f92672">+</span>ANDROID_PROJ_BASE)
        <span style="color:#66d9ef">if</span> compiler_cplus <span style="color:#f92672">==</span> True :
            <span style="color:#75715e"># print ANDROID_PROJ_BASE_ABS</span>
            ndk_root <span style="color:#f92672">=</span> check_ndk_environment()
            select_toolchain_version()
            do_build(cocos_root, ndk_root, ANDROID_PROJ_BASE_ABS)
            <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;compiler cplus plus code success&#34;</span>
        <span style="color:#66d9ef">else</span>:
            updateSo(True,ANDROID_PROJ_BASE_ABS)
        <span style="color:#75715e">#先删除apks目录</span>
        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(releaseApksFile):
            shutil<span style="color:#f92672">.</span>rmtree(releaseApksFile)
        os<span style="color:#f92672">.</span>mkdir(releaseApksFile)
        <span style="color:#75715e">#遍历生成</span>
        <span style="color:#66d9ef">for</span> project_path <span style="color:#f92672">in</span>  projects_path_local:
            app_android_root <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(current_dir, <span style="color:#e6db74">&#34;../../&#34;</span>) <span style="color:#f92672">+</span> project_path
            app_android_root<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(app_android_root)
            <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;deal project........ &#34;</span><span style="color:#f92672">+</span>project_path
            <span style="color:#75715e"># copy files</span>
            <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;begin copy resources&#34;</span>
            copy_android_res(app_android_root)
            <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;copy resources success&#34;</span>
            outputApk(app_android_root,project_path)
    <span style="color:#66d9ef">else</span>:
        resources_dir <span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(current_dir, <span style="color:#e6db74">&#34;../../Resources&#34;</span>)
        copy_ipa_res(output_path,resources_dir)
        <span style="color:#75715e"># outputIpa(projects_path)</span>
<span style="color:#75715e"># -------------- main --------------</span>
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    parser <span style="color:#f92672">=</span> OptionParser()
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;--compiler_platform&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;compiler_platform&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;compiler_platform: android 1,ios 2&#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-p&#39;</span>, <span style="color:#e6db74">&#39;--projects_path&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;projects_path&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;directory of project option of ios&#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-w&#39;</span>, <span style="color:#e6db74">&#39;--with_lua_code&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;with_lua_code&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;run game with lua  code&#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-t&#39;</span>, <span style="color:#e6db74">&#39;--ant_target&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ant_target&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;config build target ,android is ant target,ios is build setting &#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-s&#39;</span>, <span style="color:#e6db74">&#39;--compiler_cplus&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;compiler_cplus&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;compiler cplus code for android,option of ios&#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-v&#39;</span>, <span style="color:#e6db74">&#39;--version_code&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;version_code&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;new version code&#39;</span>)
    parser<span style="color:#f92672">.</span>add_option(<span style="color:#e6db74">&#39;-o&#39;</span>, <span style="color:#e6db74">&#39;--output_path&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;output_path&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Resources out put path&#39;</span>)
    opts, args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
    compiler_platform <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>compiler_platform
    projects_path <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>projects_path
    with_lua_code <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>with_lua_code
    compiler_cplus <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>compiler_cplus
    ant_target <span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>ant_target
    version_code<span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>version_code
    output_path<span style="color:#f92672">=</span> opts<span style="color:#f92672">.</span>output_path
    <span style="color:#66d9ef">if</span> compiler_platform <span style="color:#f92672">==</span>None <span style="color:#f92672">or</span> with_lua_code <span style="color:#f92672">==</span>None  :
            <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;some params not defined&#34;</span>
            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">if</span> compiler_platform <span style="color:#f92672">==</span>PLATFORM_ANDROID :
        <span style="color:#66d9ef">if</span> compiler_cplus <span style="color:#f92672">==</span>None <span style="color:#f92672">or</span> projects_path <span style="color:#f92672">==</span>None :
            <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;android build compiler_cplus and projects_path is must&#34;</span>
            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;compiler_platform is :&#34;</span><span style="color:#f92672">+</span>compiler_platform
    <span style="color:#66d9ef">if</span> compiler_cplus:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;projects_path is :&#34;</span><span style="color:#f92672">+</span>projects_path
    <span style="color:#66d9ef">print</span><span style="color:#e6db74">&#34;with_lua_code is :&#34;</span><span style="color:#f92672">+</span>with_lua_code
    <span style="color:#66d9ef">if</span> compiler_cplus:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;compiler_cplus is :&#34;</span><span style="color:#f92672">+</span>compiler_cplus
        compiler_cplus<span style="color:#f92672">=</span> int(compiler_cplus)
    <span style="color:#66d9ef">if</span> ant_target:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;ant_target is :&#34;</span><span style="color:#f92672">+</span>ant_target
    <span style="color:#66d9ef">if</span> version_code:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;version_code is :&#34;</span><span style="color:#f92672">+</span>version_code
    <span style="color:#75715e">#int to boolean</span>
    with_lua_code<span style="color:#f92672">=</span> int(with_lua_code)
    build()
</code></pre></div><p>这个python脚本用了OptionParser库来构建参数，参数说明在注释里有就不再复述了。脚本流程:</p>
<ul>
<li>检查环境变量 NDK_ROOT ,win上的TortoiseProc.exe,ant我也放到tools目录了。</li>
<li>加密lua代码</li>
<li>android平台复制资源调用各项目的build.xml编译打包 ,iOS只做资源拷贝，编译在外层的shell脚本中。</li>
</ul>
<p>build_ipa_all.sh:编译所有ipa
build_anroid_all.sh:编译所有anroid项目
渠道批量打包后,apk在releaseApks目录中,ipa中releaseIpas目录中</p>
<p><img src="https://farwmarth.bestnewbee.com/images/uploads/2014/10/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2014-10-14-%E4%B8%8B%E5%8D%885.12.50.png" alt="屏幕快照 2014 10 14 下午5 12 50" title="屏幕快照 2014-10-14 下午5.12.50.png"></p>
<p>所有脚本附上: <a href="http://pan.baidu.com/s/1o6ODJNc">http://pan.baidu.com/s/1o6ODJNc</a></p>
    </div>
    <footer class="post-footer">
     


<div class="post-tags">
     
    <a href="https://farwmarth.com/tags/cocos2d-x" rel="tag" title="cocos2d-x">#cocos2d-x#</a>
    
</div>




     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://farwmarth.com/post/%E6%B8%B8%E6%88%8Fsdk%E6%8E%A5%E5%85%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/" rel="next" title="游戏SDK接入的一些总结">
        <i class="fa fa-chevron-left"></i> 游戏SDK接入的一些总结
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://farwmarth.com/post/%E4%B8%80%E5%A5%97%E9%94%AE%E9%BC%A0%E7%9A%84%E5%BF%A7%E6%84%81/" rel="prev" title="一套键鼠的忧愁">
        一套键鼠的忧愁 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     




    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://farwmarth.com/img/author.jpg"
        alt="farwmarth" />
    <p class="site-author-name" itemprop="name">farwmarth</p>
    <p class="site-description motion-element" itemprop="description"> 
        Programmer</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://farwmarth.com/post/">
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://farwmarth.com/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://farwmarth.com/tags/">
         
        <span class="site-state-item-count">93</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/wujiyu115/" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      
    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2020</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">farwmarth</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.68.3</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://farwmarth.com/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://farwmarth.com/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://farwmarth.com/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://farwmarth.com/js/utils.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/motion.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/affix.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/scrollspy.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/post-details.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/toc.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/bootstrap.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>