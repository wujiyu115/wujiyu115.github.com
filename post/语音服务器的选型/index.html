<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>语音服务器的选型 - farwmarth</title>
    <meta name="keywords" content="程序员">
    
    <meta property="og:title" content="语音服务器的选型">
    <meta property="og:site_name" content="farwmarth">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="语音服务器的选型 - farwmarth" />
    <meta name="description" content="game"> 
    <link rel="shortcut icon" href="https://farwmarth.com/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://farwmarth.com/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://farwmarth.com/img/apple-touch-icon.png" />
    <link href="https://farwmarth.com/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/css/main.css" rel="stylesheet" type="text/css" />
    <link href="https://farwmarth.com/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://farwmarth.com/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">farwmarth</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Those that can,do.Those that can&#39;t ,complain</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/douban/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-heart"></i> <br />豆瓣
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://farwmarth.com/music/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-music"></i> <br />音乐
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://farwmarth.com/post/%E8%AF%AD%E9%9F%B3%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E9%80%89%E5%9E%8B/" itemprop="url">
        语音服务器的选型
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2017-01-06">
    2017-01-06
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://farwmarth.com/categories/audio" itemprop="url" rel="index">
        <span itemprop="name">audio</span>
      </a>
      &nbsp; 
    </span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://farwmarth.com/categories/skill" itemprop="url" rel="index">
        <span itemprop="name">skill</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">1209 字 ~3分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <h1 id="前言">前言</h1>
<p>最近游戏要接入一下语音服务器,调查了一下融合的语音sdk
腾讯云GVoice:https://www.qcloud.com/document/product/556/7673
好像只有这个比较靠谱,但是收费好像有点贵,还是决定基于原有的免费的百度语音识别造一个轮子</p>
<h1 id="选型">选型</h1>
<p>要解决几个问题</p>
<ul>
<li>语音转文字翻译</li>
<li>高效的web服务器</li>
<li>分布式的文件存储</li>
<li>与游戏服务器沟通的消息队列选择</li>
</ul>
<h2 id="语音转文字翻译">语音转文字翻译</h2>
<p>这个真没法自己造轮子,选择了百度的语音服务
语音识别<code>50000次/日</code>配额
支持的语音时长上限为60s</p>
<ul>
<li>auth文档
<a href="http://developer.baidu.com/wiki/index.php?title=docs/oauth/client">http://developer.baidu.com/wiki/index.php?title=docs/oauth/client</a></li>
<li>刷新access_token
<a href="http://developer.baidu.com/wiki/index.php?title=%E4%BD%BF%E7%94%A8Refresh_Token%E8%8E%B7%E5%8F%96Access_Token">http://developer.baidu.com/wiki/index.php?title=%E4%BD%BF%E7%94%A8Refresh_Token%E8%8E%B7%E5%8F%96Access_Token</a></li>
<li>语音识别接口
<a href="http://yuyin.baidu.com/docs/asr/57">http://yuyin.baidu.com/docs/asr/57</a></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">
<span style="color:#66d9ef">local</span> new_timer <span style="color:#f92672">=</span> ngx.timer.at

<span style="color:#66d9ef">local</span> access_token
<span style="color:#66d9ef">local</span> refresh_token

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">timer_refresh_token</span>(resp)
    <span style="color:#66d9ef">local</span> expires_in_sec <span style="color:#f92672">=</span> resp.expires_in <span style="color:#f92672">-</span> <span style="color:#ae81ff">3600</span>
    expires_in_sec <span style="color:#f92672">=</span> expires_in_sec <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">or</span> expires_in_sec
    <span style="color:#75715e">--过期前一天刷新token</span>
    new_timer(expires_in_sec,M.refresh_token)
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">gen_token</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> access_token <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">local</span> data <span style="color:#f92672">=</span> { grant_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;client_credentials&#34;</span>, client_id <span style="color:#f92672">=</span> Config.AppKey, client_secret <span style="color:#f92672">=</span> Config.AppSecret}
        <span style="color:#66d9ef">local</span> resp,err <span style="color:#f92672">=</span> http_util.get_baidu_token(Config.TOKEN_URL, data)
        access_token <span style="color:#f92672">=</span> resp.access_token
        refresh_token <span style="color:#f92672">=</span> resp.refresh_token
        M.timer_refresh_token(resp)
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">refresh_token</span>()
    <span style="color:#66d9ef">if</span> refresh_token <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">local</span> data <span style="color:#f92672">=</span> { grant_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;refresh_token&#34;</span>, client_id <span style="color:#f92672">=</span> Config.AppKey, client_secret <span style="color:#f92672">=</span> Config.AppSecret, refresh_token <span style="color:#f92672">=</span> refresh_token }
        <span style="color:#66d9ef">local</span> resp,err <span style="color:#f92672">=</span> http_util.get_baidu_token(Config.TOKEN_URL, data)
        access_token <span style="color:#f92672">=</span> resp.access_token
        refresh_token <span style="color:#f92672">=</span> resp.refresh_token
        M.timer_refresh_token(resp)
    <span style="color:#66d9ef">else</span>
        M.gen_token()
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>


<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">translate_voice</span>(voice)
    <span style="color:#66d9ef">local</span> len <span style="color:#f92672">=</span> string.len(voice)
    <span style="color:#66d9ef">local</span> base64_str <span style="color:#f92672">=</span>  ngx.encode_base64(voice)
    <span style="color:#66d9ef">local</span> data <span style="color:#f92672">=</span> {cuid <span style="color:#f92672">=</span> Config.CUID, token<span style="color:#f92672">=</span> access_token, channel <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;amr&#34;</span>, rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span>,
            len <span style="color:#f92672">=</span> len, speech <span style="color:#f92672">=</span> base64_str }
    <span style="color:#66d9ef">local</span> resp,err <span style="color:#f92672">=</span> http_util.post_ret_json(Config.VOICE_URL, data)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> err <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">local</span> err_no <span style="color:#f92672">=</span> resp.errno
        <span style="color:#66d9ef">if</span> ERR_TBL[err_no] <span style="color:#66d9ef">then</span>
            <span style="color:#66d9ef">return</span> ERR_TBL[err_no]
        <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">return</span> resp.result[<span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">return</span> err
<span style="color:#66d9ef">end</span>
</code></pre></div><h2 id="web服务器">web服务器</h2>
<p>所有的结构是在python在<code>Flask</code>上构建的,怕运行效率不行想重新写一个.几经比较之后,没有选择比较熟悉的<code>java</code>语言和<code>tornado</code>,而是选择了<code>openresty</code>,主要是基于几点考虑</p>
<ul>
<li>是否是经过验证的框架</li>
<li>是否是熟悉的开发语言</li>
<li>开发和部署是否简便快捷</li>
</ul>
<p><code>openresty</code> 是在<code>nginx</code>的基础上嵌入了<code>lua</code>的支持,兼备了<code>Python</code>快速开发和<code>Nginx C</code>模块的高性能</p>
<h2 id="文件存储">文件存储</h2>
<p>前期小规模的文件存储直接单机就可以了.而且语音这种是有时效性的,通过<code>ttl</code>过期即可清除,磁盘空间不会无限增长.
但为了做个新的尝试,也调查了一下分布式的小文件存储</p>
<ul>
<li>tfs : <a href="http://tfs.taobao.org/">http://tfs.taobao.org/</a>
<code>tfs</code>淘宝的开源方案年久失修,果断弃之</li>
<li>mogilefs : <a href="https://github.com/mogilefs">https://github.com/mogilefs</a>
要加入<code>mysql</code>弃之</li>
<li>fastdfs : <a href="https://github.com/happyfish100/fastdfs">https://github.com/happyfish100/fastdfs</a>
c编写,用的人比较多,但是看了几篇对比文章之后也没有做为最终的选择</li>
<li>seaweedfs : <a href="https://github.com/chrislusf/seaweedfs">https://github.com/chrislusf/seaweedfs</a></li>
<li>bilibfs : <a href="https://github.com/Terry-Mao/bfs">https://github.com/Terry-Mao/bfs</a>
借鉴了<code>seaweedfs</code>和<code>fastdfs</code>,<a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=406016886&amp;idx=1&amp;sn=f5aa286373fb981c9de904568fe7ddb2&amp;scene=5&amp;srcid=0411E8naA5E9O1R10U1Utv6y#rd">这篇文章</a>可以对bfs有个大概的了解,没有用这个的原因是加加入</li>
<li>baidubfs : <a href="https://github.com/baidu/bfs">https://github.com/baidu/bfs</a>
c++编写,不熟悉</li>
</ul>
<p>最终使用了<code>seaweedfs</code> go语言编写,简单易用</p>
<p>参考:
<a href="http://blog.qiniu.com/archives/2546">http://blog.qiniu.com/archives/2546</a>
<a href="http://wenjun.org/?p=1087">http://wenjun.org/?p=1087</a>
<a href="http://www.simlinux.com/books/FastDFS.pdf">http://www.simlinux.com/books/FastDFS.pdf</a></p>
<h2 id="消息队列">消息队列</h2>
<p>游戏内<code>auth</code>和后台<code>gm</code>通信中间件使用的<code>rabbitmq</code>,为了保持一致性也使用了这个</p>
<h1 id="架构">架构</h1>
<p><img src="https://farwmarth.bestnewbee.com/images/audio_server.png" alt="audio_server"></p>
<h2 id="流程">流程</h2>
<p>由玩家发起语音聊天,将语音压缩成amr上传到中心主机nginx上,由nginx反代<code>seaweedfs</code>集群完成语音文件的存储,然后将<code>返回的文件id</code>加上<code>内网的集群ip</code>组合成<code>语音id</code>将消息信息<code>push</code>到<code>rabbitmq</code>队列中,游戏服务器作为<code>mq</code>的订阅者实时处理队列内容将消息按频道和<code>语音id</code>广播给对应的游戏客户端,游戏客户端用<code>语音id</code>请求中心主机nginx再从代理的<code>seaweedfs</code>集群中取语音文件.整个语音聊天的过程就完成了.</p>
<h2 id="关于百度语音识别部分">关于百度语音识别部分</h2>
<p>百度语音识别api并不支持流式上传数据,而且把识别这部分放到上传语音的过程中加重了<code>rpc</code>调用的负担.所以这部分可以放到游戏客户端直接请求百度api</p>
    </div>
    <footer class="post-footer">
     


<div class="post-tags">
     
    <a href="https://farwmarth.com/tags/%e6%b8%b8%e6%88%8f" rel="tag" title="游戏">#游戏#</a>
    
</div>




     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://farwmarth.com/post/vultr/" rel="next" title="给shadowsocks插上tcptun,bbr这对翅膀">
        <i class="fa fa-chevron-left"></i> 给shadowsocks插上tcptun,bbr这对翅膀
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://farwmarth.com/post/ttyd/" rel="prev" title="将内网终端分享给其他人使用">
        将内网终端分享给其他人使用 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     




    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://farwmarth.com/img/author.jpg"
        alt="farwmarth" />
    <p class="site-author-name" itemprop="name">farwmarth</p>
    <p class="site-description motion-element" itemprop="description"> 
        Programmer</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://farwmarth.com/post/">
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://farwmarth.com/categories/">      
         
        <span class="site-state-item-count">32</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://farwmarth.com/tags/">
         
        <span class="site-state-item-count">93</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/wujiyu115/" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      
    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2020</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">farwmarth</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.68.3</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://farwmarth.com/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://farwmarth.com/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://farwmarth.com/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://farwmarth.com/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://farwmarth.com/js/utils.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/motion.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/affix.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/scrollspy.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/post-details.js"></script>
<script type="text/javascript" src="https://farwmarth.com/js/toc.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/bootstrap.js"></script>

<script type="text/javascript" src="https://farwmarth.com/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>