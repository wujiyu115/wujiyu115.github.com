<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="代码加密,渠道打包过程"/>













  <link rel="alternate" href="/atom.xml" title="farwmarth">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://www.farwmarth.com/代码加密,渠道打包过程/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> 代码加密,渠道打包过程 - farwmarth </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">farwmarth</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/douban">
        <li class="mobile-menu-item">
          
          
            豆瓣
          
        </li>
      </a>
    
      <a href="/music">
        <li class="mobile-menu-item">
          
          
            音乐
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">farwmarth</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/douban">
            
            
              豆瓣
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/music">
            
            
              音乐
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          代码加密,渠道打包过程
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2014-10-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/cocos2d-x/">cocos2d-x</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#lua代码加密"><span class="toc-text">lua代码加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#渠道打包"><span class="toc-text">渠道打包</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>前段时间就计划着把项目里用到的一些通用的东西整理出来，正好最近项目不是太忙，就整理一下。</p>
<a id="more"></a>
<h2 id="lua代码加密"><a href="#lua代码加密" class="headerlink" title="lua代码加密"></a><strong>lua代码加密</strong></h2><p>  我们的项目是基于cocos2dx 2.2.2 用lua开发,支持luajit,所以lua代码加密就把quick-cocos2dx的代码加密直接迁移过来(实际上就是用luajit把lua源码编译成预字节码)</p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-屏幕快照-2014-10-10-下午2.37.426.png" alt=""></p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-屏幕快照-2014-10-10-下午2.38.37-34.png" alt=""><br>调用compile_script.sh 参数说明:</p>
<p>-i 在加密的lua源码目录<br>-o 加密后的压缩包<br>-x 排除的lua文件用逗号隔开.</p>
<p>c++端的解析流程和quick大同小异:解析zip压缩包,用pakcage.preload通过lua_loadbuffer来不原。唯一有点不一样的地方是.多级目录时luajit会以点号分隔,但是我们的项目做了一段时间才做加密，所以在不不改变require的引用 语法前提下，稍微修改了一下还原步骤,将’.’还原成’/‘</p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-屏幕快照-2014-10-10-下午5.30.164.png" alt=""></p>
<h2 id="渠道打包"><a href="#渠道打包" class="headerlink" title="渠道打包"></a><strong>渠道打包</strong></h2><p>需要跨平台我选择了python作为脚本。打包流程基本流程为:</p>
<ul>
<li>加密lua代码</li>
<li>android平台编译so,或者从svn获取最新的so</li>
<li>Android平台拷贝资源到assets,iOS平台拷贝到编译目录</li>
<li>android平台上调用ant更改版本号编译项目,ios上用PlistBuddy更改版本号,用xctool命令行编译项目</li>
</ul>
<p>项目目录结构</p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/wpid-2014-10-10_21-08-421.png" width="350" height="1000"></p>
<p>每个渠道一个目录,Classes目录为公共c++代码,各平台共用.proj.android.base目录为android的基础类库依赖libcocos2dx的java工程,基础类库给各android渠道项目共用,proj.ios.common为oc公共代码给iOS各渠道项目共用。</p>
<p><strong>android平台的编译和打包解析</strong></p>
<p><strong>     基础类库mk配置</strong></p>
<p>为了共用代码将so编译放在基础类库proj.android.base中.mk配置如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line"><span class="meta">include$</span>(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE := cocos2dlua_shared</span><br><span class="line">LOCAL_MODULE_FILENAME := libcocos2dlua</span><br><span class="line"><span class="meta">#</span> 配置自己的源文件目录和源文件后缀名</span><br><span class="line">MY_FILES_PATH  :=  $(LOCAL_PATH) \</span><br><span class="line">                   $(LOCAL_PATH)/../../Classes  \</span><br><span class="line">MY_FILES_SUFFIX := %.cpp %.c</span><br><span class="line"><span class="meta">#</span> 递归遍历目录下的所有的文件</span><br><span class="line">rwildcard=$(wildcard $1$2)$(foreach d,$(wildcard $1*),$(call rwildcard,$d/,$2))</span><br><span class="line"><span class="meta">#</span> 获取相应的源文件</span><br><span class="line">MY_ALL_FILES := $(foreach src_path,$(MY_FILES_PATH), $(call rwildcard,$(src_path),*.*) ) </span><br><span class="line">MY_ALL_FILES := $(MY_ALL_FILES:$(MY_CPP_PATH)/./%=$(MY_CPP_PATH)%)</span><br><span class="line">MY_SRC_LIST  := $(filter $(MY_FILES_SUFFIX),$(MY_ALL_FILES)) </span><br><span class="line">MY_SRC_LIST  := $(MY_SRC_LIST:$(LOCAL_PATH)/%=%)</span><br><span class="line"><span class="meta">#</span> 去除字串的重复单词</span><br><span class="line">define uniq =</span><br><span class="line"><span class="meta">  $</span>(eval seen :=)</span><br><span class="line"><span class="meta">  $</span>(foreach _,$1,$(if $(filter $_,$&#123;seen&#125;),,$(eval seen += $_)))</span><br><span class="line"><span class="meta">  $</span>&#123;seen&#125;</span><br><span class="line">endef</span><br><span class="line"><span class="meta">#</span> 递归遍历获取所有目录</span><br><span class="line">MY_ALL_DIRS := $(dir $(foreach src_path,$(MY_FILES_PATH), $(call rwildcard,$(src_path),*/) ) )</span><br><span class="line">MY_ALL_DIRS := $(call uniq,$(MY_ALL_DIRS))</span><br><span class="line"><span class="meta">#</span> 赋值给NDK编译系统</span><br><span class="line">LOCAL_SRC_FILES  := $(MY_SRC_LIST)</span><br><span class="line">LOCAL_C_INCLUDES := $(MY_ALL_DIRS)</span><br><span class="line"><span class="meta">#</span>$(warning $(LOCAL_SRC_FILES))</span><br><span class="line">LOCAL_STATIC_LIBRARIES := curl_static_prebuilt</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES := cocos2dx_static</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES += cocosdenshion_static</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES += cocos_lua_static</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES += box2d_static</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES += chipmunk_static</span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES += cocos_extension_static</span><br><span class="line"><span class="meta">include$</span>(BUILD_SHARED_LIBRARY)</span><br><span class="line"><span class="meta">$</span>(call import-module,cocos2dx)</span><br><span class="line"><span class="meta">$</span>(call import-module,CocosDenshion/android)</span><br><span class="line"><span class="meta">$</span>(call import-module,scripting/lua/proj.android)</span><br><span class="line"><span class="meta">$</span>(call import-module,cocos2dx/platform/third_party/android/prebuilt/libcurl)</span><br><span class="line"><span class="meta">$</span>(call import-module,extensions)</span><br><span class="line"><span class="meta">$</span>(call import-module,external/Box2D)</span><br><span class="line"><span class="meta">$</span>(call import-module,external/chipmunk)</span><br></pre></td></tr></table></figure>
<p>上面的配置会遍历项目jni目录和项目上级的classes目录达到自动添加cpp和.h的目的,这样不要频繁去理发mk文件了。</p>
<p><strong>    android项目的编译过程</strong></p>
<pre><code>![15205029 814db23b81404db1bffc9ffb0da5f270](http://farwmarth.bestnewbee.com/images/uploads/2014/10/15205029-814db23b81404db1bffc9ffb0da5f270.png &quot;15205029-814db23b81404db1bffc9ffb0da5f270.png&quot;)
</code></pre><ul>
<li>首先.aidl(Android Interface Description Language)文件需要通过aidl工具转换成编译器能处理的Java接口文件</li>
<li>同时资源文件将被aapt (Asset Packaging Tool)处理为最终的resources.arsc，并生成R.java文件以使源码可以方便地访问到这些资源</li>
<li>Java的编译器将R.java, Java源码以及上述生成的接口文件统一编译成.class文件</li>
<li>不过.class并不是Android系统所能识别的格式，因而还要利用dex工具转化为Dalvik字节码。这其中还会加入所有需要的第三方库等文件</li>
<li>接下来系统将上面生成的dex，资源包，以及其它资源通过apkbuilder生成初始的apk文件包。这时还没有签名和优化</li>
<li>签名可以用Jarsigner，也可以用其它类似的工具。如果是在Debug模式下，所签名所用的keystore就是系统默认自带的，否则开发者需要提供自己的私钥以完成签名过程</li>
<li><p>最后一步，将上述签名后的apk通过zipalign进行优化，以提高加载和运行速度。大概原理是通过对其中包含的相关数据进行边界对齐，来加快读取和处理。这也同时解释了其名称”zip”+”align”的由来</p>
<p>  好在android sdk tools中已经将ant编译脚本写好了，只要直接调用就可以了。</p>
</li>
</ul>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/屏幕快照-2014-10-13-下午1.28.07.png" alt="屏幕快照 2014 10 13 下午1 28 07" title="屏幕快照 2014-10-13 下午1.28.07.png"></p>
<pre><code>项目中build.xml内容,这里只定义了一个target，在编译完成后在手机上自动运行一个app，此build.xml在能用的python脚本里会调用
</code></pre><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;?xmlversion="1.0"encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span></span></span><br><span class="line"><span class="tag">    <span class="attr">name</span>=<span class="string">"sanguo"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">default</span>=<span class="string">"sanguoBuildAll"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">propertyfile="ant.properties"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loadpropertiessrcFile="project.properties"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">targetname="apkBuildBefore"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">echomessage="apk</span> <span class="attr">build</span> <span class="attr">before</span> <span class="attr">....</span>"/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">targetname="runApp"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec</span></span></span><br><span class="line"><span class="tag"><span class="attr">executable</span>=<span class="string">"adb"</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">argline="shell</span> <span class="attr">am</span> <span class="attr">start</span> <span class="attr">-n</span> <span class="attr">com.sanguo.game.uc</span>/<span class="attr">com.sanguo.game.uc.sanguo</span>"/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">exec</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">propertyname="common.buildxml"location="..</span>/<span class="attr">tools</span>/<span class="attr">build</span>/<span class="attr">build_common_android.xml</span>"/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--导入共用build--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">importfile="$&#123;common.buildxml&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>tools目录中公用的build_common_android.xml内容,些ant主要任务是替换版本号(用到了xmltask库),编译android项目并运行.<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;?xmlversion="1.0"encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">projectname="commonBuild"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">taskdefname="xmltask"classname="com.oopsconsultancy.xmltask.ant.XmlTask"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">propertyenvironment="env"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name="project.versionname" value="1" /&gt;</span></span><br><span class="line"><span class="comment">&lt;property name="project.versioncode" value="1" /&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">propertyname="manifest.file"location="$&#123;basedir&#125;</span>/<span class="attr">AndroidManifest.xml</span>"/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">echomessage="build</span> <span class="attr">project</span> <span class="attr">path</span> <span class="attr">is</span> <span class="attr">:</span> $&#123;<span class="attr">basedir</span>&#125;"/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">echomessage="AndroidManifest.xml</span> <span class="attr">path</span> <span class="attr">is</span> <span class="attr">:</span> $&#123;<span class="attr">manifest.file</span>&#125;"/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">condition</span></span></span><br><span class="line"><span class="tag"><span class="attr">property</span>=<span class="string">"sdk.dir"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">"$&#123;env.ANDROID_HOME&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">issetproperty="env.ANDROID_HOME"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">condition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fail</span></span></span><br><span class="line"><span class="tag">        <span class="attr">message</span>=<span class="string">"sdk.dir missing, please config  ANDROID_HOME environment variable."</span></span></span><br><span class="line"><span class="tag"><span class="attr">unless</span>=<span class="string">"sdk.dir"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--完整编译--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"sanguoBuildAll"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">depends</span>=<span class="string">"sanguoBuildNotInstall,intallSanguo"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">description</span>=<span class="string">"install sanguo application"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--完整编译但是不安装--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"sanguoBuildNotInstall"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">depends</span>=<span class="string">"replace_manifest,apkBuildBefore,clean,release"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">description</span>=<span class="string">"install sanguo application"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--安装并运行--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"intallSanguo"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">depends</span>=<span class="string">"installr,runApp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">description</span>=<span class="string">"install sanguo application"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--替换版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">targetname="replace_manifest_check"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionproperty="has.version"</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">issetproperty="project.versionname"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">condition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">targetname="replace_manifest"if="has.version"depends="replace_manifest_check"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xmltasksource="$&#123;manifest.file&#125;"dest="$&#123;manifest.file&#125;"encoding="utf-8"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">attrpath="</span>//<span class="attr">manifest</span>"<span class="attr">attr</span>=<span class="string">"android:versionName"</span><span class="attr">value</span>=<span class="string">"$&#123;project.versionname&#125;"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">attrpath="</span>//<span class="attr">manifest</span>"<span class="attr">attr</span>=<span class="string">"android:versionCode"</span><span class="attr">value</span>=<span class="string">"$&#123;project.versioncode&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xmltask</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">echomessage="new</span> <span class="attr">version</span> <span class="attr">is:</span> $&#123;<span class="attr">project.versionname</span>&#125; , $&#123;<span class="attr">project.versioncode</span>&#125;"/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">echomessage="replace_manifest</span> <span class="attr">version</span> <span class="attr">code</span> <span class="attr">success</span> <span class="attr">....</span>"/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">importfile="$&#123;sdk.dir&#125;</span>/<span class="attr">tools</span>/<span class="attr">ant</span>/<span class="attr">build.xml</span>"/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>IOS项目的编译过程</strong></p>
<p><strong>xcode打包过程</strong></p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/xcodebuild2.jpg" alt="Xcodebuild" title="xcodebuild.jpg"></p>
<ul>
<li><p>编译源文件（Compile Sources）连接二进制文件和库（Link Binary With Libraries）<br>这个阶段编译所有的源文件；默认情况下，项目中添加任何一个源文件，也将添加到编译列表中。<br>Compile Sources 构建阶段分为两步：预处理（Preprocessing）和编译（Compiling）。<br><code>预处理（Preprocessing）</code><br>的目标是为每一个实现文件（.m）创建中间文件（intermediate file）。中间文件仍然类似实现文件的Objective-C代码，但是中间文件会变得非常大。<br>在创建中间文件时，预处理器负责处理实现文件（.m）中所有的预处理指令（preprocessor directives）。预处理指令是所有以 # 开头的语句，如 #import。#import 语句将替换为实际引用文件的内容。<br>例如，一个实现文件 .m 引用了.h 头文件；为 .m 创建的中间文件将包含 .h和 .m文件。还不止这些，并且 .h 头文件引用了其他 2 个文件 UIKit.h和CoreLocation.h，还有可能这 2 个文件引用了其他的头文件 .h，这些头文件将全部包含在该实现文件.m    创建的中间文件中（intermediate file）。<br><code>编译（Compiling）</code><br>一旦预编译（Preprocessor）完成之后，接着编译生成的中间文件（intermediate files），编译中间文件 – Objective-C 代码，生成机器码（machine code）。机器码存放在对象文件（object file）中，一个中间文件对应一个对象文件。<br>编译阶段，也就是将Objective代码文件转为机器码，将检测多数编译错误。当编译器不理解我们编写的代码时，将报错。我们称之为编译错误或语法错误。<br><code>连接（Linking）</code><br>编译生成的对象文件（object file）包含了实现文件（implementation file）的机器码。在一个实现文件中，可以调用其他实现文件的方法。此时，并不会将其他实现文件的代码复制到本实现文件中，而是连接其他实现文件。连接二进制文件和库（Link Binary With Libraries）就是负责此项任务，我们简称连接阶段（linking phase）。</p>
</li>
<li><p>复制绑定资源（Copy Bundle Resources）<br>在源文件编译和连接库之后，创建一个可执行文件，并放置在应用程序的绑定中，其实就是一个文件夹。<br>其中资源文件将和可执行文件一起添加到绑定（bundle）中。这些资源文件是数据文件，应用程序在运行时需要使用，如XIB 文件和图像文件、声音文件等等。<br>默认情况下，添加到项目中的文件，如不是源代码文件，将添加到这个构建阶段（Build Phase）。<br>如果图片资源是PNG格式，那么不仅仅对其进行拷贝，还会做一些优化(如果build settings中的PNG优化是打开的)</p>
</li>
<li><p>运行指定脚本<br>如果在build phases 下指定了run Script,在这里会运行脚本。<br>我在项目中的脚本内容如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">_TARGET_BUILD_CONTENTS_PATH=$TARGET_BUILD_DIR/$CONTENTS_FOLDER_PATH</span><br><span class="line">echo Target Path: $_TARGET_BUILD_CONTENTS_PATH</span><br><span class="line">BUILD_PATH=$&#123;PWD&#125;/../tools/build/build_native.py</span><br><span class="line">python $BUILD_PATH -c 2  -w 0 -o $_TARGET_BUILD_CONTENTS_PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包签名<br>调用command tools打包签名</p>
</li>
</ul>
<p><strong>脚本打包</strong></p>
<p>脚本打包一般采用xcodebuild和xcrun.</p>
<p>这里在github中有一个用它打包的shell库,包括了打包上传邮件通知，功能比较完整(<a href="https://github.com/webfrogs/xcode_shell" target="_blank" rel="noopener">https://github.com/webfrogs/xcode_shell</a>)</p>
<p>xcodebuild这种打包方式缺点是编译过程中输出太不人性化，难以查看，所以我找了facebook开源的的一个打包的库xctool.</p>
<p>打包脚本build_ipa_all.sh如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>--------------------------------------------</span><br><span class="line"><span class="meta">#</span> 功能：编译xcode项目并打ipa包</span><br><span class="line"><span class="meta">#</span> 使用说明：</span><br><span class="line"><span class="meta">#</span> 编译workspace</span><br><span class="line"><span class="meta">#</span>build_ipa_all   proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sangup91  140902</span><br><span class="line"><span class="meta">#</span> 作者：farwmarth</span><br><span class="line"><span class="meta">#</span> E-mail:[wujiyu115@gmail.com](mailto:wujiyu115@gmail.com)</span><br><span class="line"><span class="meta">#</span> 创建日期：2014-09-23 15:17:19</span><br><span class="line"><span class="meta">#</span>--------------------------------------------</span><br><span class="line"><span class="meta">#</span>build前清除之前的目录</span><br><span class="line">clean_app_build_dic=true</span><br><span class="line"><span class="meta">#</span>是否只通过*.app来生成ipa</span><br><span class="line">only_packge_ipa=false</span><br><span class="line"><span class="meta">#</span>#############配置工程目录和scheme名称,scheme名称要和xcodeproj一致,用空格隔开#############</span><br><span class="line"><span class="meta">#</span>要打包的项目</span><br><span class="line">project_config=$1</span><br><span class="line"><span class="meta">#</span>新版本</span><br><span class="line">new_version_code=$2</span><br><span class="line"><span class="meta">#</span>去空格</span><br><span class="line">new_version_code=$(echo $new_version_code)</span><br><span class="line">if  [[ ! $new_version_code =~ ^[0-9]+$ ]] || [ $&#123;#new_version_code&#125; -ne 6 ]  ; then</span><br><span class="line">echo new_version_code is not number or the length is not six</span><br><span class="line">exit2</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span>###############################</span><br><span class="line">str_dic=""</span><br><span class="line">str_scheme=""</span><br><span class="line">for item in $(echo $project_config | tr ":" "\n")</span><br><span class="line">do</span><br><span class="line">  count=1</span><br><span class="line">for config in $(echo $item | tr "#" "\n")</span><br><span class="line">do</span><br><span class="line"><span class="meta">#</span> echo $count</span><br><span class="line">if [ $count = 1 ];then</span><br><span class="line">str_dic=$str_dic" "$config</span><br><span class="line">fi</span><br><span class="line">if [ $count = 2 ] ;then</span><br><span class="line">str_scheme=$str_scheme" "$config</span><br><span class="line">fi</span><br><span class="line">let "count++"</span><br><span class="line">done</span><br><span class="line">done</span><br><span class="line">echo $str_dic</span><br><span class="line">echo $str_scheme</span><br><span class="line">dicArray=($str_dic)</span><br><span class="line">schemeArray=($str_scheme)</span><br><span class="line"><span class="meta">#</span> exit 0</span><br><span class="line"><span class="meta">#</span>############安装brew 和xctool#############</span><br><span class="line">if which brew 2&amp;gt;/dev/null; then</span><br><span class="line">  echo "brew exists!"</span><br><span class="line">else</span><br><span class="line">  echo "nope, no brew installed, begin install"</span><br><span class="line">  curl -LsSf http://github.com/mxcl/homebrew/tarball/master | sudo tar xvz -C/usr/local --strip 1</span><br><span class="line">fi</span><br><span class="line">if which xctool&amp;gt;/dev/null; then</span><br><span class="line">  echo "xctool exists!"</span><br><span class="line">else</span><br><span class="line">  echo "nope, no xctool installed, begin install"</span><br><span class="line">  sudo brew update</span><br><span class="line">  sudo brew install xctool</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span> xctool -scheme sanguopp -reporter plain:log.txt  archive  -archivePath ./xctoolBuild</span><br><span class="line"><span class="meta">#</span>############批量打包应用#############</span><br><span class="line">dic_count=$&#123;#dicArray[@]&#125;</span><br><span class="line">scheme_count=$&#123;#schemeArray[@]&#125;</span><br><span class="line">if [ dic_count!=0 ] &amp;amp;&amp;amp; [ $dic_count != $scheme_count ] ; then</span><br><span class="line">echo "dic count not equesl scheme count!"</span><br><span class="line">exit2</span><br><span class="line">fi</span><br><span class="line">build_path=$(pwd)</span><br><span class="line">ios_build_path=$build_path/releaseIpas</span><br><span class="line">ios_ipa_build_path=$build_path/releaseIpas/ipabuild</span><br><span class="line">if [ $clean_app_build_dic  ] &amp;amp;&amp;amp; [ -d $ios_build_path ]; then</span><br><span class="line">rm -rf $ios_build_path</span><br><span class="line">fi</span><br><span class="line">if [ ! -d $ios_ipa_build_path ] ; then</span><br><span class="line">mkdir -p $ios_ipa_build_path</span><br><span class="line">fi</span><br><span class="line">function replace_info_list()&#123;</span><br><span class="line">app_infoplist_path=$1</span><br><span class="line">schemeName=$2</span><br><span class="line"><span class="meta">#</span>取版本号</span><br><span class="line">bundleShortVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleShortVersionString" $&#123;app_infoplist_path&#125;)</span><br><span class="line"><span class="meta">#</span>取build值</span><br><span class="line">bundleVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleVersion" $&#123;app_infoplist_path&#125;)</span><br><span class="line">hasPoint=false</span><br><span class="line">temp_version_code=$new_version_code</span><br><span class="line">if [[ $bundleShortVersion =~ "." ]];then</span><br><span class="line">    hasPoint=true</span><br><span class="line">else</span><br><span class="line">hasPoint=false</span><br><span class="line">fi</span><br><span class="line">if [ "$hasPoint" == true ]; then</span><br><span class="line">temp_version_code=$(echo  $temp_version_code|awk  'BEGIN&#123;FS=""&#125;&#123;print $1$2"."$3$4"."$5$6&#125;')</span><br><span class="line">fi</span><br><span class="line">echo $schemeName old CFBundleShortVersionString,CFBundleVersion is: $bundleShortVersion , $bundleVersion</span><br><span class="line">echo $schemeName ipa new_version_code is: $temp_version_code</span><br><span class="line">    /usr/libexec/Plistbuddy -c "Set CFBundleVersion $temp_version_code""$&#123;app_infoplist_path&#125;"</span><br><span class="line">    /usr/libexec/Plistbuddy -c "Set CFBundleShortVersionString $temp_version_code""$&#123;app_infoplist_path&#125;"</span><br><span class="line">&#125;</span><br><span class="line">function build_release()&#123;</span><br><span class="line">schemeName=$2</span><br><span class="line">project_path=$1/$scheme".xcodeproj"</span><br><span class="line"><span class="meta">#</span>app文件中Info.plist文件路径</span><br><span class="line">app_infoplist_path=$1/Info.plist</span><br><span class="line"><span class="meta">#</span>ipa名称</span><br><span class="line">ipa_name=$schemeName"_"$(date +"%Y%m%d")</span><br><span class="line"><span class="meta">#</span>scheme路径</span><br><span class="line">target_ios_build_path=$ios_build_path/$schemeName</span><br><span class="line"><span class="meta">#</span>生成.app的路径</span><br><span class="line">target_ios_app_path=$target_ios_build_path".xcarchive/Products/Applications/*.app"</span><br><span class="line"><span class="meta">#</span>发布的ipa路径</span><br><span class="line">ipa_publish_path=$ios_ipa_build_path/$&#123;ipa_name&#125;.ipa</span><br><span class="line">replace_info_list $app_infoplist_path $schemeName</span><br><span class="line">if [  "$only_packge_ipa" == false ] ; then</span><br><span class="line">echo  xctool build begin...</span><br><span class="line">xctool -project $project_path -scheme $schemeName clean</span><br><span class="line">xctool -project $project_path -scheme $schemeName archive  -archivePath $target_ios_build_path</span><br><span class="line">fi</span><br><span class="line">if [ -d $target_ios_app_path ] ; then</span><br><span class="line">xcrun -sdk iphoneos PackageApplication -v $target_ios_app_path -o  $ipa_publish_path</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line">for (( i=0;i&amp;lt;$dic_count;i=i+1))</span><br><span class="line">do</span><br><span class="line">dic=$&#123;dicArray[$i]&#125;</span><br><span class="line">scheme=$&#123;schemeArray[$i]&#125;</span><br><span class="line">p_path=../../$dic</span><br><span class="line">if [ -d $p_path ] ; then</span><br><span class="line">build_release $p_path $scheme</span><br><span class="line">else</span><br><span class="line">echo "this project is not exists :"$p_path</span><br><span class="line">fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>脚本使用方法 build_ipa_all   proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sangup91  140902<br>第一个参数:工程目录名#要编译的scheme名:工程目录名#要编译的scheme名<br>第二个参数:新版本名<br>如果没有xctool，脚本会自动安装,然后调用PlistBuddy替换版本号，然后调用xctool打包。<br>编译所有ios项目的脚本build_ipa_all.sh:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta"> #</span>!/bin/bash</span><br><span class="line">newVersion=140902</span><br><span class="line">allproj='proj.ios#sanguo:proj.ios.pp#sanguopp:proj.ios_91#sanguo91:proj.ios_xy#sanguoXY'</span><br><span class="line">python build_native.py -c 2  -w 0</span><br><span class="line">. ./build_common_ipa.sh $allproj $newVersion</span><br></pre></td></tr></table></figure>
<p>最后来看下android和iOS公用的python脚本build_native.py: </p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># build_native.py</span></span><br><span class="line"><span class="comment"># Build native codes</span></span><br><span class="line"><span class="comment">#--------------------------------------------</span></span><br><span class="line"><span class="comment"># 功能：加密处理资源</span></span><br><span class="line"><span class="comment"># 使用说明：</span></span><br><span class="line"><span class="comment">#   '-c', '--compiler_platform', dest='compiler_platform', help='编译android用1,编译ipa用2')</span></span><br><span class="line"><span class="comment">#   '-p', '--projects_path', dest='projects_path', help='项目目录名,如proj.android,编译ipa单个项目时可不指定,为空值时不调用xctool脚本打包')</span></span><br><span class="line"><span class="comment">#   '-w', '--with_lua_code', dest='with_lua_code', help='1为带源lua源码,0为加密lua代码')</span></span><br><span class="line"><span class="comment">#   '-t', '--ant_target', dest='ant_target', help='编译android时 为"None"值:不调用build.xml,为空值时调用默认的target,有值时调用对应的ant target')</span></span><br><span class="line"><span class="comment">#   '-s', '--compiler_cplus', dest='compiler_cplus', help='调用ndk编译c++代码，编译ipa时无用')</span></span><br><span class="line"><span class="comment">#   '-v', '--version_code', dest='version_code', help='新的版本号')</span></span><br><span class="line"><span class="comment">#   '-o', '--output_path', dest='output_path', help='资源加密后输出目录,可选')</span></span><br><span class="line"><span class="comment"># 作者：farwmarth</span></span><br><span class="line"><span class="comment"># E-mail:[wujiyu115@gmail.com](mailto:wujiyu115@gmail.com)</span></span><br><span class="line"><span class="comment"># 创建日期：2014-09-23 15:17:19</span></span><br><span class="line"><span class="comment">#--------------------------------------------</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os, os.path, stat, shutil</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line">PLATFORM_ANDROID = <span class="string">"1"</span></span><br><span class="line">PLATFORM_IOS = <span class="string">"2"</span></span><br><span class="line">SO_PATH=<span class="string">"/libs/armeabi/libcocos2dlua.so"</span></span><br><span class="line">ANDROID_PROJ_BASE=<span class="string">"proj.android.base"</span></span><br><span class="line">PROJ_SO_BASE=ANDROID_PROJ_BASE+SO_PATH</span><br><span class="line">CURR_DIR = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">releaseApksFile = os.path.abspath(CURR_DIR+<span class="string">"/releaseApks/"</span>)</span><br><span class="line">ANT_PATH=os.path.abspath(os.path.join(CURR_DIR)+<span class="string">"/../ant/bin/ant"</span>)</span><br><span class="line">with_lua_code = <span class="keyword">False</span>  <span class="comment"># 是否运行lua源码</span></span><br><span class="line">compiler_cplus = <span class="keyword">False</span>  <span class="comment"># android上是否编译c++代码</span></span><br><span class="line">compiler_platform = <span class="number">1</span>  <span class="comment"># 编译的平台 android还是ios</span></span><br><span class="line">projects_path =<span class="keyword">None</span>  <span class="comment"># 项目要目录 </span></span><br><span class="line">ant_target = <span class="keyword">None</span><span class="comment"># android ant 目标</span></span><br><span class="line">version_code = <span class="keyword">None</span> <span class="comment"># 新版本号</span></span><br><span class="line">output_path = <span class="keyword">None</span> <span class="comment">#资源处理好后输出目录</span></span><br><span class="line"><span class="comment"># 检查ndk环境变量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_ndk_environment</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">''' Checking the environment NDK_ROOT, which will be used for building</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        NDK_ROOT = os.environ[<span class="string">'NDK_ROOT'</span>]</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">print</span><span class="string">"NDK_ROOT not defined. Please define NDK_ROOT in your environment"</span></span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> NDK_ROOT</span><br><span class="line"><span class="comment">#检查环境变量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_environment_variables</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> compiler_platform==PLATFORM_ANDROID :</span><br><span class="line">        svnResult = <span class="keyword">None</span></span><br><span class="line">        antResult = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span>(isWin32()):</span><br><span class="line">            svnResult = check_cmd_path(<span class="string">"TortoiseProc.exe"</span>)</span><br><span class="line">            antResult = check_cmd_path(<span class="string">"ant"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            svnResult = check_cmd_path(<span class="string">"svn"</span>)</span><br><span class="line">            antResult = check_cmd_path(<span class="string">"ant"</span>)</span><br><span class="line">        <span class="comment"># print svnResult</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> svnResult :</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#检查路径里面是否包含某可执行文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_cmd_path</span><span class="params">(executePath)</span>:</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    dirs = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">if</span>(isWin32()):</span><br><span class="line">        dirs = os.environ[<span class="string">'PATH'</span>].split(<span class="string">';'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dirs = os.environ[<span class="string">'PATH'</span>].split(<span class="string">':'</span>)</span><br><span class="line">    <span class="keyword">for</span> cmdpath <span class="keyword">in</span> dirs :</span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(cmdpath) <span class="keyword">and</span>  executePath <span class="keyword">in</span> os.listdir(cmdpath):</span><br><span class="line">            result = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">         <span class="keyword">print</span><span class="string">"please check environment variables   "</span> + executePath</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="comment"># ndk编译链</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_toolchain_version</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''ndk-r8e  -&amp;gt; use gcc4.7</span></span><br><span class="line"><span class="string">    ndk-r9   -&amp;gt; use gcc4.8</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    ndk_root = check_ndk_environment()</span><br><span class="line">    <span class="keyword">if</span> os.path.isdir(os.path.join(ndk_root, <span class="string">"toolchains/arm-linux-androideabi-4.8"</span>)):</span><br><span class="line">        os.environ[<span class="string">'NDK_TOOLCHAIN_VERSION'</span>] = <span class="string">'4.8'</span></span><br><span class="line">        <span class="keyword">print</span><span class="string">"The Selected NDK toolchain version was 4.8 !"</span></span><br><span class="line">    <span class="keyword">elif</span> os.path.isdir(os.path.join(ndk_root, <span class="string">"toolchains/arm-linux-androideabi-4.7"</span>)):</span><br><span class="line">        os.environ[<span class="string">'NDK_TOOLCHAIN_VERSION'</span>] = <span class="string">'4.7'</span></span><br><span class="line">        <span class="keyword">print</span><span class="string">"The Selected NDK toolchain version was 4.7 !"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span><span class="string">"Couldn't find the gcc toolchain."</span></span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># ndk编译c++</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_build</span><span class="params">(cocos_root, ndk_root, app_android_root)</span>:</span></span><br><span class="line">    ndk_path = os.path.join(ndk_root, <span class="string">"ndk-build"</span>)</span><br><span class="line">    <span class="comment"># windows should use ";" to seperate module paths</span></span><br><span class="line">    platform = sys.platform</span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">'win32'</span>:</span><br><span class="line">        ndk_module_path = <span class="string">'NDK_MODULE_PATH=%s;%s/cocos2dx/platform/third_party/android/prebuilt'</span> % (cocos_root, cocos_root)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ndk_module_path = <span class="string">'NDK_MODULE_PATH=%s:%s/cocos2dx/platform/third_party/android/prebuilt'</span> % (cocos_root, cocos_root)</span><br><span class="line">    command = <span class="string">'%s -C %s %s'</span> % (ndk_path, app_android_root, ndk_module_path)</span><br><span class="line">    os.system(command)</span><br><span class="line"><span class="comment"># 赋权操作</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subFileChmod</span><span class="params">(_sPath, _stat)</span>:</span></span><br><span class="line">     itemsInDir = os.listdir(_sPath);</span><br><span class="line">     <span class="keyword">for</span> item <span class="keyword">in</span> itemsInDir:</span><br><span class="line">         sItemPath = os.path.join(_sPath, item);</span><br><span class="line">         os.chmod(sItemPath, _stat);</span><br><span class="line">         <span class="keyword">if</span> os.path.isdir(sItemPath):</span><br><span class="line">             subFileChmod(sItemPath, _stat);</span><br><span class="line"><span class="comment"># 拷贝文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_files</span><span class="params">(src, dst)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> os.listdir(src):</span><br><span class="line">        path = os.path.join(src, item)</span><br><span class="line">        <span class="comment"># Android can not package the file that ends with ".gz"</span></span><br><span class="line">        <span class="keyword">if</span> with_lua_code == <span class="keyword">False</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> item.startswith(<span class="string">'UserDefault.xml'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'.'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.endswith(<span class="string">'.gz'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.endswith(<span class="string">'.dll'</span>)  <span class="keyword">and</span> <span class="keyword">not</span> item.endswith(<span class="string">'.exe'</span>)  <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'start.bat'</span>) <span class="keyword">and</span> os.path.isfile(path):</span><br><span class="line">                shutil.copy(path, dst)</span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(path) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'.svn'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'script'</span>) <span class="keyword">and</span> item != <span class="string">'cache'</span> <span class="keyword">and</span> item != <span class="string">'editor'</span>  <span class="keyword">and</span> item != <span class="string">'.settings'</span>  <span class="keyword">and</span> item != <span class="string">'_gsdata_'</span>  :</span><br><span class="line">                new_dst = os.path.join(dst, item)</span><br><span class="line">                <span class="keyword">if</span> os.path.exists(new_dst):</span><br><span class="line">                    shutil.rmtree(new_dst)</span><br><span class="line">                os.mkdir(new_dst)</span><br><span class="line">                copy_files(path, new_dst)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> item.startswith(<span class="string">'UserDefault.xml'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'.'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.endswith(<span class="string">'.gz'</span>) <span class="keyword">and</span>  <span class="keyword">not</span> item.endswith(<span class="string">'.dll'</span>)  <span class="keyword">and</span> <span class="keyword">not</span> item.endswith(<span class="string">'.exe'</span>) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'start.bat'</span>) <span class="keyword">and</span>  item != <span class="string">'js'</span> <span class="keyword">and</span> os.path.isfile(path):</span><br><span class="line">                shutil.copy(path, dst)</span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(path) <span class="keyword">and</span> <span class="keyword">not</span> item.startswith(<span class="string">'.svn'</span>) <span class="keyword">and</span> item != <span class="string">'cache'</span> <span class="keyword">and</span> item != <span class="string">'editor'</span>  <span class="keyword">and</span> item != <span class="string">'.settings'</span> <span class="keyword">and</span> item != <span class="string">'_gsdata_'</span>  :</span><br><span class="line">                new_dst = os.path.join(dst, item)</span><br><span class="line">                <span class="keyword">if</span> os.path.exists(new_dst):</span><br><span class="line">                    shutil.rmtree(new_dst)</span><br><span class="line">                os.mkdir(new_dst)</span><br><span class="line">                copy_files(path, new_dst)</span><br><span class="line"><span class="comment"># 拷贝资源</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_resources</span><span class="params">(resources_dir,assets_dir,remove_assets)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> remove_assets:</span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(assets_dir):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"delete "</span>+assets_dir</span><br><span class="line">            shutil.rmtree(assets_dir)</span><br><span class="line">        os.mkdir(assets_dir)</span><br><span class="line">    <span class="keyword">if</span> os.path.isdir(resources_dir):</span><br><span class="line">        copy_files(resources_dir, assets_dir)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_android_res</span><span class="params">(app_android_root)</span>:</span></span><br><span class="line">    assets_dir = os.path.join(app_android_root, <span class="string">"assets"</span>)</span><br><span class="line">    resources_dir = os.path.join(app_android_root, <span class="string">"../Resources"</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.isdir(resources_dir) <span class="keyword">and</span> os.path.isdir(assets_dir):</span><br><span class="line">        copy_resources(resources_dir,assets_dir,<span class="keyword">True</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_ipa_res</span><span class="params">(app_output_path,resources_dir)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> app_output_path!=<span class="keyword">None</span> <span class="keyword">and</span> resources_dir!=<span class="keyword">None</span> <span class="keyword">and</span> os.path.isdir(app_output_path) <span class="keyword">and</span> os.path.isdir(resources_dir):</span><br><span class="line">        copy_resources(resources_dir,app_output_path,<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 加密lua代码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dumplua</span><span class="params">(current_dir)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> with_lua_code == <span class="keyword">False</span>:</span><br><span class="line">        command = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span>(isWin32()):</span><br><span class="line">            command =os.path.abspath(current_dir+<span class="string">"/../dump/dump.bat"</span>)</span><br><span class="line">            command = <span class="string">"call "</span>+command</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            command =os.path.abspath(current_dir+<span class="string">"/../dump/dump.sh"</span>)</span><br><span class="line">        <span class="keyword">if</span> command :</span><br><span class="line">            <span class="comment"># print command</span></span><br><span class="line">            os.system(command)</span><br><span class="line"><span class="comment"># 是否是windows平台</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isWin32</span><span class="params">()</span>:</span></span><br><span class="line">    sysstr = platform.system()</span><br><span class="line">    <span class="keyword">return</span> sysstr == <span class="string">"Windows"</span></span><br><span class="line"><span class="comment">#更新so文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateSo</span><span class="params">(update,app_android_root)</span>:</span></span><br><span class="line">    <span class="keyword">print</span><span class="string">"update so file"</span></span><br><span class="line">    <span class="comment"># print update</span></span><br><span class="line">    command =<span class="keyword">None</span></span><br><span class="line">    PROJ_SO_BASE_ABS = os.path.abspath(app_android_root+<span class="string">"/../"</span>+PROJ_SO_BASE)</span><br><span class="line">    <span class="comment"># print PROJ_SO_BASE_ABS</span></span><br><span class="line">    <span class="keyword">if</span> update ==<span class="keyword">True</span> :</span><br><span class="line">        <span class="keyword">if</span>(isWin32()):</span><br><span class="line">            command=<span class="string">"TortoiseProc.exe /command:update /path:"</span>+PROJ_SO_BASE_ABS+<span class="string">" /closeonend:1"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            command=<span class="string">"svn update "</span>+PROJ_SO_BASE_ABS</span><br><span class="line">        os.system(command)</span><br><span class="line">        <span class="keyword">print</span><span class="string">"update so file success"</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outputApk</span><span class="params">(app_android_root,project_path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> ant_target != <span class="string">"None"</span>:</span><br><span class="line">        <span class="keyword">print</span><span class="string">".................outputApk"</span></span><br><span class="line">        command= ANT_PATH+<span class="string">"  -buildfile  "</span> + app_android_root+<span class="string">"/build.xml  "</span></span><br><span class="line">        <span class="keyword">if</span> ant_target:</span><br><span class="line">            <span class="keyword">if</span> ant_target ==<span class="string">"sanguoBuildNotInstall"</span>:</span><br><span class="line">                command =command + <span class="string">" -q "</span></span><br><span class="line">            command = command+ant_target</span><br><span class="line">        <span class="keyword">if</span> version_code:</span><br><span class="line">            command = command+<span class="string">" -Dproject.versionname="</span>+version_code+<span class="string">" -Dproject.versioncode="</span>+version_code</span><br><span class="line">        <span class="keyword">print</span> command</span><br><span class="line">        <span class="keyword">if</span> command :</span><br><span class="line">            os.system(command)</span><br><span class="line">        <span class="keyword">if</span> ant_target ==<span class="string">"sanguoBuildNotInstall"</span>:</span><br><span class="line">            releaseApk = os.path.abspath(app_android_root+<span class="string">"/bin/sanguo-release.apk"</span>)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(releaseApk):</span><br><span class="line">                destPath=releaseApksFile+<span class="string">"/"</span>+project_path+<span class="string">".apk"</span></span><br><span class="line">                <span class="comment"># print destPath</span></span><br><span class="line">                shutil.copy(releaseApk,destPath)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"copy  "</span>+project_path+<span class="string">" apk success"</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outputIpa</span><span class="params">(app_projects_path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>  app_projects_path != <span class="keyword">None</span>:</span><br><span class="line">        command = <span class="string">". ./build_common_ipa.sh  "</span>+app_projects_path</span><br><span class="line">        os.system(command)</span><br><span class="line"><span class="comment"># 处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span><span class="params">()</span> :</span></span><br><span class="line">    <span class="comment"># check_environment_variables</span></span><br><span class="line">    check_environment_variables()</span><br><span class="line">    <span class="comment"># set Path</span></span><br><span class="line">    current_dir = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">    cocos_root = os.path.join(current_dir, <span class="string">"../../../.."</span>)</span><br><span class="line">    <span class="comment"># dumpLua</span></span><br><span class="line">    dumplua(current_dir)</span><br><span class="line">    <span class="keyword">if</span> compiler_platform==PLATFORM_ANDROID :</span><br><span class="line">        <span class="comment">#如果在函数内修改全局变量则视他为一个局部变量</span></span><br><span class="line">        projects_path_local = projects_path.split(<span class="string">":"</span>)</span><br><span class="line">        projectLen=len(projects_path_local)</span><br><span class="line">        ANDROID_PROJ_BASE_ABS=os.path.abspath(os.path.join(current_dir, <span class="string">"../../"</span>) +ANDROID_PROJ_BASE)</span><br><span class="line">        <span class="keyword">if</span> compiler_cplus == <span class="keyword">True</span> :</span><br><span class="line">            <span class="comment"># print ANDROID_PROJ_BASE_ABS</span></span><br><span class="line">            ndk_root = check_ndk_environment()</span><br><span class="line">            select_toolchain_version()</span><br><span class="line">            do_build(cocos_root, ndk_root, ANDROID_PROJ_BASE_ABS)</span><br><span class="line">            <span class="keyword">print</span><span class="string">"compiler cplus plus code success"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            updateSo(<span class="keyword">True</span>,ANDROID_PROJ_BASE_ABS)</span><br><span class="line">        <span class="comment">#先删除apks目录</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(releaseApksFile):</span><br><span class="line">            shutil.rmtree(releaseApksFile)</span><br><span class="line">        os.mkdir(releaseApksFile)</span><br><span class="line">        <span class="comment">#遍历生成</span></span><br><span class="line">        <span class="keyword">for</span> project_path <span class="keyword">in</span>  projects_path_local:</span><br><span class="line">            app_android_root = os.path.join(current_dir, <span class="string">"../../"</span>) + project_path</span><br><span class="line">            app_android_root=os.path.abspath(app_android_root)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"deal project........ "</span>+project_path</span><br><span class="line">            <span class="comment"># copy files</span></span><br><span class="line">            <span class="keyword">print</span><span class="string">"begin copy resources"</span></span><br><span class="line">            copy_android_res(app_android_root)</span><br><span class="line">            <span class="keyword">print</span><span class="string">"copy resources success"</span></span><br><span class="line">            outputApk(app_android_root,project_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        resources_dir =os.path.join(current_dir, <span class="string">"../../Resources"</span>)</span><br><span class="line">        copy_ipa_res(output_path,resources_dir)</span><br><span class="line">        <span class="comment"># outputIpa(projects_path)</span></span><br><span class="line"><span class="comment"># -------------- main --------------</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = OptionParser()</span><br><span class="line">    parser.add_option(<span class="string">'-c'</span>, <span class="string">'--compiler_platform'</span>, dest=<span class="string">'compiler_platform'</span>, help=<span class="string">'compiler_platform: android 1,ios 2'</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-p'</span>, <span class="string">'--projects_path'</span>, dest=<span class="string">'projects_path'</span>, help=<span class="string">'directory of project option of ios'</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-w'</span>, <span class="string">'--with_lua_code'</span>, dest=<span class="string">'with_lua_code'</span>, help=<span class="string">'run game with lua  code'</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-t'</span>, <span class="string">'--ant_target'</span>, dest=<span class="string">'ant_target'</span>, help=<span class="string">'config build target ,android is ant target,ios is build setting '</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-s'</span>, <span class="string">'--compiler_cplus'</span>, dest=<span class="string">'compiler_cplus'</span>, help=<span class="string">'compiler cplus code for android,option of ios'</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-v'</span>, <span class="string">'--version_code'</span>, dest=<span class="string">'version_code'</span>, help=<span class="string">'new version code'</span>)</span><br><span class="line">    parser.add_option(<span class="string">'-o'</span>, <span class="string">'--output_path'</span>, dest=<span class="string">'output_path'</span>, help=<span class="string">'Resources out put path'</span>)</span><br><span class="line">    opts, args = parser.parse_args()</span><br><span class="line">    compiler_platform = opts.compiler_platform</span><br><span class="line">    projects_path = opts.projects_path</span><br><span class="line">    with_lua_code = opts.with_lua_code</span><br><span class="line">    compiler_cplus = opts.compiler_cplus</span><br><span class="line">    ant_target = opts.ant_target</span><br><span class="line">    version_code= opts.version_code</span><br><span class="line">    output_path= opts.output_path</span><br><span class="line">    <span class="keyword">if</span> compiler_platform ==<span class="keyword">None</span> <span class="keyword">or</span> with_lua_code ==<span class="keyword">None</span>  :</span><br><span class="line">            <span class="keyword">print</span><span class="string">"some params not defined"</span></span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> compiler_platform ==PLATFORM_ANDROID :</span><br><span class="line">        <span class="keyword">if</span> compiler_cplus ==<span class="keyword">None</span> <span class="keyword">or</span> projects_path ==<span class="keyword">None</span> :</span><br><span class="line">            <span class="keyword">print</span><span class="string">"android build compiler_cplus and projects_path is must"</span></span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">print</span><span class="string">"compiler_platform is :"</span>+compiler_platform</span><br><span class="line">    <span class="keyword">if</span> compiler_cplus:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"projects_path is :"</span>+projects_path</span><br><span class="line">    <span class="keyword">print</span><span class="string">"with_lua_code is :"</span>+with_lua_code</span><br><span class="line">    <span class="keyword">if</span> compiler_cplus:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"compiler_cplus is :"</span>+compiler_cplus</span><br><span class="line">        compiler_cplus= int(compiler_cplus)</span><br><span class="line">    <span class="keyword">if</span> ant_target:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"ant_target is :"</span>+ant_target</span><br><span class="line">    <span class="keyword">if</span> version_code:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"version_code is :"</span>+version_code</span><br><span class="line">    <span class="comment">#int to boolean</span></span><br><span class="line">    with_lua_code= int(with_lua_code)</span><br><span class="line">    build()</span><br></pre></td></tr></table></figure>
<p>这个python脚本用了OptionParser库来构建参数，参数说明在注释里有就不再复述了。脚本流程:</p>
<ul>
<li>检查环境变量 NDK_ROOT ,win上的TortoiseProc.exe,ant我也放到tools目录了。</li>
<li>加密lua代码</li>
<li>android平台复制资源调用各项目的build.xml编译打包 ,iOS只做资源拷贝，编译在外层的shell脚本中。</li>
</ul>
<p>build_ipa_all.sh:编译所有ipa<br>build_anroid_all.sh:编译所有anroid项目<br>渠道批量打包后,apk在releaseApks目录中,ipa中releaseIpas目录中</p>
<p><img src="http://farwmarth.bestnewbee.com/images/uploads/2014/10/屏幕快照-2014-10-14-下午5.12.50.png" alt="屏幕快照 2014 10 14 下午5 12 50" title="屏幕快照 2014-10-14 下午5.12.50.png"></p>
<p>所有脚本附上: <a href="http://pan.baidu.com/s/1o6ODJNc" target="_blank" rel="noopener">http://pan.baidu.com/s/1o6ODJNc</a></p>

      
    </div>

    
      
      



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/wechat.png" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/alipay.png" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/游戏SDK接入的一些总结/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">游戏SDK接入的一些总结</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/一套键鼠的忧愁/">
        <span class="next-text nav-default">一套键鼠的忧愁</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:wujiyu115@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="http://github.com/wujiyu115" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="/farwmwarth" class="iconfont icon-instagram" title="instagram"></a>
        
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2011 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">farwmarth</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
